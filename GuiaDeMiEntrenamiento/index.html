<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anzo's Style</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
    
    <!-- XLSX.js CDN (para exportar a Excel) -->
    <!-- Añadido shim para compatibilidad con ES5 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/shim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Estilos personalizados -->
    <style>
        /* Asignación de fuentes */
        body {
            /* Merriweather como fuente principal 'sans' */
            font-family: 'Merriweather', 'Times New Roman', serif;
        }
        
        /* Lora para títulos y elementos destacados */
        .font-lora {
            font-family: 'Lora', 'Times New Roman', serif;
        }
        
        /* Merriweather para el cuerpo de texto */
        .font-merriweather {
            font-family: 'Merriweather', 'Times New Roman', serif;
        }

        /* Animación del Loader */
        @keyframes pulse-loader {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.05);
            }
        }
        #loader {
            animation: pulse-loader 2s ease-in-out infinite;
        }
        
        /* Animación suave de aparición */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        /* Transición suave de altura para el menú móvil */
        #menu-links {
            transition: max-height 0.3s ease-out;
        }
        
        /* Estilos para scroll-behavior (aunque JS lo manejará) */
        html {
            scroll-behavior: smooth;
        }
        
        /* Estilos de scrollbar personalizados */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #a8a8a8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        
        /* Estilos de scrollbar modo oscuro */
        .dark ::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #718096; /* gray-500 */
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0; /* gray-400 */
        }
        
        /* Ocultar flechas en input[type=number] */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-merriweather transition-colors duration-300">

    <!-- ==== Loader ==== -->
    <div id="loader" class="fixed inset-0 z-[100] flex items-center justify-center bg-gray-100 dark:bg-gray-900">
        <h1 class="text-4xl md:text-5xl font-lora font-bold text-blue-600 dark:text-blue-400">Anzo's Style</h1>
    </div>

    <!-- ==== Header ==== -->
    <header class="sticky top-0 z-40 w-full bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg shadow-md transition-colors duration-300">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo/Título -->
                <div class="flex-shrink-0">
                    <a href="#" data-page="home" class="text-2xl font-lora font-bold text-blue-600 dark:text-blue-400">Anzo's Style</a>
                </div>
                
                <!-- Menú de Navegación (Escritorio) -->
                <div class="hidden md:block">
                    <div class="ml-10 flex items-center space-x-4">
                        <a href="#" data-page="start-routine" class="nav-link px-3 py-2 rounded-md text-sm font-medium hover:text-blue-600 dark:hover:text-blue-400">Comenzar Rutina</a>
                        <a href="#" data-page="routine-chest" class="nav-link px-3 py-2 rounded-md text-sm font-medium hover:text-blue-600 dark:hover:text-blue-400">Pecho y Tríceps</a>
                        <a href="#" data-page="routine-back" class="nav-link px-3 py-2 rounded-md text-sm font-medium hover:text-blue-600 dark:hover:text-blue-400">Espalda y Bíceps</a>
                        <a href="#" data-page="routine-leg" class="nav-link px-3 py-2 rounded-md text-sm font-medium hover:text-blue-600 dark:hover:text-blue-400">Pierna</a>
                        <a href="#" data-page="routine-shoulders" class="nav-link px-3 py-2 rounded-md text-sm font-medium hover:text-blue-600 dark:hover:text-blue-400">Deltoides y Trapecio</a>
                        <a href="#" data-page="stats" class="nav-link px-3 py-2 rounded-md text-sm font-medium hover:text-blue-600 dark:hover:text-blue-400">Estadísticas</a>
                    </div>
                </div>

                <!-- Icono de Configuración y Menú Móvil -->
                <div class="flex items-center">
                    <!-- Icono de Configuración -->
                    <button id="settings-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>

                    <!-- Botón Menú Móvil -->
                    <div class="-mr-2 flex md:hidden ml-2">
                        <button id="menu-toggle" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white" aria-controls="menu-links" aria-expanded="false">
                            <span class="sr-only">Abrir menú principal</span>
                            <!-- Icono de hamburguesa -->
                            <svg id="menu-icon-open" class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                            <!-- Icono de X -->
                            <svg id="menu-icon-close" class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Panel Menú Móvil -->
            <div class="md:hidden hidden max-h-0" id="menu-links">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    <a href="#" data-page="start-routine" class="nav-link block px-3 py-2 rounded-md text-base font-medium hover:text-blue-600 dark:hover:text-blue-400">Comenzar Rutina</a>
                    <a href="#" data-page="routine-chest" class="nav-link block px-3 py-2 rounded-md text-base font-medium hover:text-blue-600 dark:hover:text-blue-400">Pecho y Tríceps</a>
                    <a href="#" data-page="routine-back" class="nav-link block px-3 py-2 rounded-md text-base font-medium hover:text-blue-600 dark:hover:text-blue-400">Espalda y Bíceps</a>
                    <a href="#" data-page="routine-leg" class="nav-link block px-3 py-2 rounded-md text-base font-medium hover:text-blue-600 dark:hover:text-blue-400">Pierna</a>
                    <a href="#" data-page="routine-shoulders" class="nav-link block px-3 py-2 rounded-md text-base font-medium hover:text-blue-600 dark:hover:text-blue-400">Deltoides y Trapecio</a>
                    <a href="#" data-page="stats" class="nav-link block px-3 py-2 rounded-md text-base font-medium hover:text-blue-600 dark:hover:text-blue-400">Estadísticas</a>
                </div>
            </div>
        </nav>
    </header>

    <!-- ==== Panel de Configuración (Dropdown) ==== -->
    <div id="settings-panel" class="hidden absolute top-16 right-4 z-30 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 transition-all duration-300 transform origin-top-right">
        <div class="p-4 space-y-4">
            <!-- Modo Claro/Oscuro -->
            <div class="flex items-center justify-between">
                <span class="text-sm font-medium">Modo Oscuro</span>
                <button id="dark-mode-toggle" class="relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none bg-gray-200 dark:bg-blue-600">
                    <span class="sr-only">Toggle Dark Mode</span>
                    <span class="inline-block w-5 h-5 rounded-full bg-white shadow transform transition ease-in-out duration-200 translate-x-0 dark:translate-x-5"></span>
                </button>
            </div>
            
            <!-- Reiniciar Estadísticas -->
            <div>
                <button id="reset-stats-btn" class="w-full text-left px-3 py-2 rounded-md text-sm font-medium text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors duration-200">
                    Reiniciar Estadísticas
                </button>
            </div>
        </div>
    </div>


    <!-- ==== Contenido Principal (SPA) ==== -->
    <main id="app-content" class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- ==== Página: Home ==== -->
        <section id="home" class="app-page fade-in">
            <div class="text-center max-w-3xl mx-auto bg-white dark:bg-gray-800 p-8 md:p-12 rounded-xl shadow-lg">
                <h1 class="text-4xl md:text-5xl font-lora font-bold text-gray-900 dark:text-white mb-8">
                    Bienvenido a tu viaje
                </h1>
                <div class="space-y-6 text-left text-base md:text-lg leading-relaxed text-gray-700 dark:text-gray-300">
                    <p>Hola, soy Antonio, un apasionado del entrenamiento y del desarrollo personal. Hace más de dos años decidí dar un paso importante: empezar a cuidarme, tanto física como mentalmente. Desde entonces, el gimnasio se ha convertido en mucho más que un lugar donde entreno; es el espacio donde me desafío, crezco y descubro de lo que realmente soy capaz.</p>
                    <p>A lo largo de este camino he aprendido que el progreso no solo se mide en kilos levantados o centímetros ganados, sino en constancia, disciplina y actitud. Mi cuerpo ha cambiado, sí, pero sobre todo ha cambiado mi forma de pensar, mi confianza y mi manera de afrontar la vida.</p>
                    <p>Después de muchas horas de práctica, errores y aprendizajes, he desarrollado una forma de entrenar que se adapta a mí y me permite mejorar día a día. Y aunque sé que cada persona es única, quiero compartir mi experiencia para que otros puedan encontrar su propio camino hacia una versión mejor de sí mismos.</p>
                    <p>Esta página nace con un propósito: inspirarte, motivarte y acompañarte en tu proceso. Aquí compartiré mis rutinas, consejos, reflexiones y todo lo que me ha ayudado a mantenerme constante, incluso cuando las ganas flaquean. Porque entrenar no es solo una cuestión de fuerza física, sino también de mentalidad, constancia y pasión.</p>
                    <p>Si estás aquí, es porque quieres dar un paso más. Quiero que sepas que puedes lograrlo, y que con esfuerzo y dedicación los resultados llegan. Este no es solo mi viaje, también puede ser el tuyo.</p>
                </div>
                <button data-page="start-routine" class="nav-link mt-10 px-8 py-3 bg-blue-600 text-white text-lg font-lora font-semibold rounded-full shadow-lg hover:bg-blue-700 transform hover:scale-105 transition-all duration-300">
                    Comenzar Rutina
                </button>
            </div>
        </section>

        <!-- ==== Página: Comenzar Rutina ==== -->
        <section id="start-routine" class="app-page hidden">
            
            <!-- Vista 1: Selección de Rutina -->
            <div id="routine-selection" class="fade-in">
                <h2 class="text-3xl md:text-4xl font-lora font-bold text-center mb-10">Selecciona tu Rutina</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                    
                    <!-- Card Pecho -->
                    <div class="routine-card bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-2 transition-all duration-300 hover:shadow-2xl">
                        <div class="p-6 text-center">
                            <h3 class="text-2xl font-lora font-semibold mb-4">Pecho y Tríceps</h3>
                            <button data-routine="chest" class="select-routine-btn w-full px-6 py-2 bg-blue-600 text-white font-semibold rounded-full hover:bg-blue-700 transition-colors duration-300">
                                Seleccionar rutina
                            </button>
                        </div>
                    </div>
                    
                    <!-- Card Espalda -->
                    <div class="routine-card bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-2 transition-all duration-300 hover:shadow-2xl">
                        <div class="p-6 text-center">
                            <h3 class="text-2xl font-lora font-semibold mb-4">Espalda y Bíceps</h3>
                            <button data-routine="back" class="select-routine-btn w-full px-6 py-2 bg-blue-600 text-white font-semibold rounded-full hover:bg-blue-700 transition-colors duration-300">
                                Seleccionar rutina
                            </button>
                        </div>
                    </div>
                    
                    <!-- Card Pierna -->
                    <div class="routine-card bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-2 transition-all duration-300 hover:shadow-2xl">
                        <div class="p-6 text-center">
                            <h3 class="text-2xl font-lora font-semibold mb-4">Pierna</h3>
                            <button data-routine="leg" class="select-routine-btn w-full px-6 py-2 bg-blue-600 text-white font-semibold rounded-full hover:bg-blue-700 transition-colors duration-300">
                                Seleccionar rutina
                            </button>
                        </div>
                    </div>
                    
                    <!-- Card Deltoides -->
                    <div class="routine-card bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-2 transition-all duration-300 hover:shadow-2xl">
                        <div class="p-6 text-center">
                            <h3 class="text-2xl font-lora font-semibold mb-4">Deltoides y Trapecio</h3>
                            <button data-routine="shoulders" class="select-routine-btn w-full px-6 py-2 bg-blue-600 text-white font-semibold rounded-full hover:bg-blue-700 transition-colors duration-300">
                                Seleccionar rutina
                            </button>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- Vista 2: Seguimiento de Rutina (se rellena con JS) -->
            <div id="routine-tracker" class="hidden fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="tracker-title" class="text-3xl md:text-4xl font-lora font-bold"></h2>
                    <button id="back-to-selection" class="text-sm text-blue-600 dark:text-blue-400 hover:underline">&larr; Volver a seleccionar</button>
                </div>

                <!-- Barra de Progreso -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-blue-700 dark:text-blue-300">Progreso de la Rutina</span>
                        <span id="progress-text" class="text-sm font-medium text-blue-700 dark:text-blue-300">0 / 0 Completados</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Lista de Ejercicios (se rellena con JS) -->
                <div id="tracker-list" class="space-y-6">
                    <!-- Contenido dinámico de ejercicios -->
                </div>
                
                <!-- Botón de Finalizar -->
                <div class="text-center mt-10">
                    <button id="finish-routine-btn" class="px-10 py-3 bg-green-600 text-white text-lg font-lora font-semibold rounded-full shadow-lg hover:bg-green-700 transform hover:scale-105 transition-all duration-300">
                        Suficiente por hoy
                    </button>
                </div>
            </div>

        </section>
        
        <!-- ==== Página: Pecho y Tríceps (Solo lectura) ==== -->
        <section id="routine-chest" class="app-page hidden fade-in">
            <h2 class="text-3xl md:text-4xl font-lora font-bold mb-8">Rutina: Pecho y Tríceps</h2>
            <div id="routine-chest-content" class="space-y-8">
                <!-- Contenido generado por JS -->
            </div>
        </section>

        <!-- ==== Página: Espalda y Bíceps (Solo lectura) ==== -->
        <section id="routine-back" class="app-page hidden fade-in">
            <h2 class="text-3xl md:text-4xl font-lora font-bold mb-8">Rutina: Espalda y Bíceps</h2>
            <div id="routine-back-content" class="space-y-8">
                <!-- Contenido generado por JS -->
            </div>
        </section>

        <!-- ==== Página: Pierna (Solo lectura) ==== -->
        <section id="routine-leg" class="app-page hidden fade-in">
            <h2 class="text-3xl md:text-4xl font-lora font-bold mb-8">Rutina: Pierna</h2>
            <div id="routine-leg-content" class="space-y-8">
                <!-- Contenido generado por JS -->
            </div>
        </section>
        
        <!-- ==== Página: Deltoides y Trapecio (Solo lectura) ==== -->
        <section id="routine-shoulders" class="app-page hidden fade-in">
            <h2 class="text-3xl md:text-4xl font-lora font-bold mb-8">Rutina: Deltoides y Trapecio</h2>
            <div id="routine-shoulders-content" class="space-y-8">
                <!-- Contenido generado por JS -->
            </div>
        </section>

        <!-- ==== Página: Estadísticas ==== -->
        <section id="stats" class="app-page hidden fade-in">
            <h2 class="text-3xl md:text-4xl font-lora font-bold mb-8">Estadísticas</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Resumen Semanal -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-lora font-semibold mb-4">Resumen Semanal</h3>
                    <div class="flex items-baseline space-x-2">
                        <span id="stats-weekly-count" class="text-5xl font-bold text-blue-600 dark:text-blue-400">0</span>
                        <span class="text-lg text-gray-600 dark:text-gray-400">Entrenamientos</span>
                    </div>
                </div>

                <!-- Progreso General (Gráfico Simple) -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-lora font-semibold mb-4">Progreso General (Total)</h3>
                    <div class="space-y-2" id="stats-graph">
                        <!-- Gráfico simple generado por JS -->
                        <p class="text-gray-500 dark:text-gray-400">Aún no hay datos para mostrar.</p>
                    </div>
                </div>
            </div>

            <!-- Historial de Rutinas -->
            <div class="mt-10 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-lora font-semibold">Historial de Rutinas</h3>
                    <button id="export-excel-btn" class="px-4 py-2 bg-green-600 text-white text-sm font-semibold rounded-full shadow-md hover:bg-green-700 transition-colors duration-300">
                        Exportar a Excel (.xlsx)
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full min-w-max text-left">
                        <thead>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <th class="py-3 px-4 text-sm font-semibold uppercase">Fecha</th>
                                <th class="py-3 px-4 text-sm font-semibold uppercase">Rutina</th>
                                <th class="py-3 px-4 text-sm font-semibold uppercase">Ejercicios Completados</th>
                            </tr>
                        </thead>
                        <tbody id="stats-history-table">
                            <!-- Filas generadas por JS -->
                            <tr>
                                <td colspan="3" class="text-center py-6 text-gray-500 dark:text-gray-400">No hay rutinas completadas.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>
    
    <!-- ==== Cronómetro Persistente ==== -->
    <div id="persistent-timer" class="hidden fixed bottom-6 right-6 z-50 bg-gray-900 dark:bg-white text-white dark:text-gray-900 rounded-lg shadow-2xl p-4 w-60">
        <h4 class="font-lora text-lg font-semibold text-center mb-2">Cronómetro</h4>
        <div id="timer-display" class="text-5xl font-mono text-center mb-3">00:00</div>
        <div class="flex justify-around">
            <button id="timer-start-pause" class="w-16 px-3 py-1 bg-green-500 dark:bg-green-600 text-white rounded hover:bg-green-600 dark:hover:bg-green-700 transition-colors">
                Iniciar
            </button>
            <button id="timer-reset" class="w-16 px-3 py-1 bg-red-500 dark:bg-red-600 text-white rounded hover:bg-red-600 dark:hover:bg-red-700 transition-colors">
                Reset
            </button>
        </div>
    </div>

    <!-- ==== Botón Scroll-to-Top ==== -->
    <button id="scroll-to-top" class="hidden fixed bottom-6 left-6 z-50 p-3 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 focus:outline-none transition-all duration-300 opacity-0">
        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
        </svg>
    </button>
    
    <!-- ==== Toast Notification ==== -->
    <div id="toast" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 z-50 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl transition-all duration-300 transform translate-y-10 opacity-0">
        <div class="flex items-center justify-between">
            <span id="toast-message" class="mr-4">Mensaje</span>
            <div id="toast-actions" class="flex space-x-2">
                <!-- Botones de confirmación (opcional) -->
            </div>
        </div>
    </div>


    <!-- ==== JavaScript Principal ==== -->
    <script>
        // --- BASE DE DATOS DE RUTINAS ---
        const routinesDB = {
            'chest': {
                id: 'chest',
                name: 'Pecho y Tríceps',
                blocks: [
                    { 
                        name: 'Fuerza Pectoral', 
                        exercises: [
                            { id: 'c1', name: 'Press banca unilateral en máquina', details: '6x5 rep, 80-85% RM', description: 'Siéntate y ajusta el asiento. Empuja el manillar hacia adelante de forma controlada, enfocándote en el pectoral. Regresa lentamente.' },
                            { id: 'c2', name: 'Press inclinado con mancuernas', details: '5x8 rep', description: 'En un banco inclinado, baja las mancuernas a los lados del pecho, codos a 45º. Empuja hacia arriba y júntalas.' }
                        ]
                    },
                    {
                        name: 'Hipertrofia Pectoral',
                        exercises: [
                            { id: 'c3', name: 'Press en máquina convergente', details: '4x10-12 rep', description: 'Ajusta el asiento. Empuja los manillares hasta que casi se toquen, apretando el pecho. Vuelve controlado.' },
                            { id: 'c4', name: 'Peck deck', details: '3x10 rep + dropset', description: 'Siéntate con la espalda recta. Lleva los manillares al centro apretando el pecho. Aguanta 1 segundo y regresa.' },
                            { id: 'c5', name: 'Peck deck de pie', details: '3x al fallo', description: 'Usando poleas, inclínate ligeramente y junta las manos al frente, cruzándolas un poco. Contracción máxima.' }
                        ]
                    },
                    {
                        name: 'Tríceps',
                        exercises: [
                            { id: 'c6', name: 'Press cerrado en banca', details: '5x8-10 rep', description: 'Agarre a la anchura de los hombros. Baja la barra al esternón, codos pegados al cuerpo. Empuja con los tríceps.' },
                            { id: 'c7', name: 'Press francés con barra Z', details: '4x10-12 rep', description: 'Tumbado, baja la barra Z hacia la frente o detrás de la cabeza, codos fijos. Extiende con los tríceps.' },
                            { id: 'c8', name: 'Extensiones en polea con cuerda', details: '4x12-15 rep', description: 'De pie, codos fijos a los costados. Extiende la cuerda hacia abajo separando las manos al final. Aprieta el tríceps.' },
                            { id: 'c9', name: 'Extensión overhead con mancuerna', details: '4x12-15 rep', description: 'Sentado o de pie, sujeta una mancuerna con ambas manos. Baja la mancuerna detrás de la cabeza, codos apuntando al techo. Extiende.' }
                        ]
                    },
                    {
                        name: 'Finisher',
                        exercises: [
                            { id: 'c10', name: 'Press JM', details: '4x8-10 rep, peso moderado', description: 'Híbrido entre press cerrado y francés. Baja la barra hacia el cuello/clavícula, codos adelante. Empuja.' }
                        ]
                    }
                ]
            },
            'back': {
                id: 'back',
                name: 'Espalda y Bíceps',
                blocks: [
                    {
                        name: 'Espalda (tirón vertical y horizontal)',
                        exercises: [
                            { id: 'b1', name: 'Jalón al pecho abierto', details: '2 series al fallo + parciales', description: 'Agarre abierto. Tira de la barra hacia la parte superior del pecho, sacando pecho y retrayendo escápulas. Vuelve controlado.' },
                            { id: 'b2', name: 'Remo Gironda', details: '2 series al fallo + parciales', description: 'Sentado, pies en la plataforma. Tira del agarre hacia el abdomen, retrayendo escápulas. Espalda recta.' },
                            { id: 'b3', name: 'Remo en punta', details: '2 series al fallo', description: 'Agarra la barra T. Mantén la espalda recta y paralela al suelo. Tira de la barra hacia el pecho, codos pegados.' }
                        ]
                    },
                    {
                        name: 'Espalda (unilateral y estiramiento)',
                        exercises: [
                            { id: 'b4', name: 'Remo unilateral en máquina', details: '3 series', description: 'Siéntate de lado o de frente. Tira del manillar hacia la cadera, rotando el torso ligeramente. Enfócate en el dorsal.' },
                            { id: 'b5', name: 'Pullover unilateral en polea alta', details: '3 series al fallo con dropset', description: 'De pie, coge el estribo. Brazo casi recto, llévalo en un arco hacia tu cadera, apretando el dorsal.' }
                        ]
                    },
                    {
                        name: 'Bíceps',
                        exercises: [
                            { id: 'b6', name: 'Predicador con barra Z o mancuernas', details: '3 series al fallo', description: 'Apoya los tríceps en el banco. Baja la barra de forma controlada y súbela apretando el bíceps. No extiendas del todo.' },
                            { id: 'b7', name: 'Curl inclinado con mancuernas', details: '3 series al fallo', description: 'En banco inclinado, deja colgar los brazos. Sube una mancuerna y luego la otra, supinando la muñeca. Estira bien.' }
                        ]
                    },
                    {
                        name: 'Finisher',
                        exercises: [
                            { id: 'b8', name: 'Peso muerto convencional modo bombeo', details: '3-4x12-15 rep, 60-70% RM', description: 'Agarre prono. Espalda recta, baja la barra rozando las piernas hasta la espinilla. Sube apretando glúteos e isquios.' }
                        ]
                    }
                ]
            },
            'leg': {
                id: 'leg',
                name: 'Pierna',
                blocks: [
                    {
                        name: 'Isquiotibiales',
                        exercises: [
                            { id: 'l1', name: 'Curl femoral sentado', details: '2x6-8 rep al fallo + parciales', description: 'Ajusta el rodillo sobre los tobillos. Flexiona las rodillas llevando los talones hacia el glúteo. Regresa lento.' },
                            { id: 'l2', name: 'Curl femoral tumbado', details: '2x6-8 rep al fallo + parciales', description: 'Tumbado boca abajo. Flexiona las rodillas llevando los talones al glúteo. Aprieta los isquios.' }
                        ]
                    },
                    {
                        name: 'Cuádriceps',
                        exercises: [
                            { id: 'l3', name: 'Hack Squat', details: '3x6-8 rep al fallo', description: 'Espalda pegada al respaldo, pies a la anchura de los hombros. Baja rompiendo el paralelo (90º). Empuja con los cuádriceps.' },
                            { id: 'l4', name: 'Squat en multipower', details: '3x6-8 rep al fallo', description: 'Barra sobre los trapecios. Pies ligeramente adelantados. Baja la cadera como si te sentaras. Mantén espalda recta.' }
                        ]
                    },
                    {
                        name: 'Peso muerto / glúteo',
                        exercises: [
                            { id: 'l5', name: 'Peso muerto rumano con cinturón', details: '3x6-8 rep', description: 'Espalda recta. Baja la barra rozando las piernas, cadera hacia atrás. Siente el estiramiento en isquios. Sube con la cadera.' }
                        ]
                    },
                    {
                        name: 'Aislantes y accesorios',
                        exercises: [
                            { id: 'l6', name: 'Extensión de cuádriceps', details: '3 series + dropset', description: 'Sentado, ajusta el rodillo en el tobillo. Extiende las piernas apretando el cuádriceps. Aguanta 1 seg y baja.' },
                            { id: 'l7', name: 'Abductores y aductores', details: '3 series + dropset', description: 'En la máquina, empuja hacia afuera (abductor) o hacia adentro (aductor) de forma controlada.' },
                            { id: 'l8', name: 'Gemelos', details: '3 series de 30 segundos', description: 'En máquina o de pie. Eleva los talones lo máximo posible. Aguanta 1 seg y baja estirando bien.' }
                        ]
                    }
                ]
            },
            'shoulders': {
                id: 'shoulders',
                name: 'Deltoides y Trapecio',
                blocks: [
                    {
                        name: 'Deltoide anterior / fuerza',
                        exercises: [
                            { id: 's1', name: 'Press militar con barra', details: '5x6-8 rep', description: 'De pie o sentado. Barra a la altura de la clavícula. Empuja la barra sobre la cabeza, codos hacia adelante. Vuelve controlado.' },
                            { id: 's2', name: 'Press con mancuernas sentado', details: '4x8-10 rep', description: 'Sentado con respaldo. Sube las mancuernas desde los hombros hasta estirar brazos. Baja controlado.' }
                        ]
                    },
                    {
                        name: 'Deltoide lateral / aislantes',
                        exercises: [
                            { id: 's3', name: 'Elevaciones laterales', details: '4x12-15 rep', description: 'Ligeramente inclinado. Eleva las mancuernas a los lados, codos semi-flexionados, hasta altura del hombro.' },
                            { id: 's4', name: 'Pájaros o elevaciones posteriores', details: '4x12-15 rep', description: 'Inclinado (pecho paralelo al suelo) o en máquina. Eleva los brazos lateralmente, apretando el deltoides posterior.' },
                            { id: 's5', name: 'Face Pulls', details: '3-4x12-15 rep', description: 'Con cuerda en polea alta. Tira de la cuerda hacia la cara, separando las manos. Rota externamente los hombros.' }
                        ]
                    },
                    {
                        name: 'Trapecio / bombeo',
                        exercises: [
                            { id: 's6', name: 'Encogimientos con barra o mancuernas', details: '4x12-15 rep', description: 'De pie, con barra o mancuernas. Encoge los hombros hacia las orejas. No uses los brazos. Aguanta 1 seg.' },
                            { id: 's7', name: 'Remo al mentón', details: '3x10-12 rep', description: 'Agarre cerrado en barra Z o polea. Tira de la barra hacia el mentón, codos por encima de las manos. Controla la bajada.' }
                        ]
                    },
                    {
                        name: 'Finisher',
                        exercises: [
                            { id: 's8', name: 'Elevaciones frontales', details: '2-3x10-12 rep', description: 'Con mancuernas o disco. Eleva el peso al frente, brazo recto, hasta la altura del hombro. Baja lento.' },
                            { id: 's9', name: 'Press banca moderado', details: '2-3x10-12 rep', description: 'Como el press banca estándar, pero con peso más ligero para bombear el deltoide anterior.' }
                        ]
                    }
                ]
            }
        };

        // --- ESTADO GLOBAL ---
        const state = {
            currentPage: 'home',
            darkMode: false,
            stats: {
                history: [], // { date, name, exercisesCompleted, totalExercises }
            },
            timer: {
                isRunning: false,
                startTime: 0,
                elapsedTime: 0,
                intervalId: null
            },
            currentRoutine: null // { routineId, name, exercises: [ { id, name, details, completed, sets, weight } ] }
        };

        // --- SELECTORES DOM ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const dom = {
            html: $('html'),
            loader: $('#loader'),
            header: $('header'),
            appContent: $('#app-content'),
            appPages: $$('.app-page'),
            navLinks: $$('.nav-link'),
            menuToggle: $('#menu-toggle'),
            menuIconOpen: $('#menu-icon-open'),
            menuIconClose: $('#menu-icon-close'),
            menuLinks: $('#menu-links'),
            settingsToggle: $('#settings-toggle'),
            settingsPanel: $('#settings-panel'),
            darkModeToggle: $('#dark-mode-toggle'),
            resetStatsBtn: $('#reset-stats-btn'),
            scrollToTopBtn: $('#scroll-to-top'),
            toast: $('#toast'),
            toastMessage: $('#toast-message'),
            toastActions: $('#toast-actions'),
            // Páginas
            routineSelection: $('#routine-selection'),
            routineTracker: $('#routine-tracker'),
            selectRoutineBtns: $$('.select-routine-btn'),
            trackerTitle: $('#tracker-title'),
            trackerList: $('#tracker-list'),
            progressText: $('#progress-text'),
            progressBar: $('#progress-bar'),
            finishRoutineBtn: $('#finish-routine-btn'),
            backToSelectionBtn: $('#back-to-selection'),
            // Contenedores de rutinas (lectura)
            routineContainers: {
                chest: $('#routine-chest-content'),
                back: $('#routine-back-content'),
                leg: $('#routine-leg-content'),
                shoulders: $('#routine-shoulders-content'),
            },
            // Estadísticas
            statsWeeklyCount: $('#stats-weekly-count'),
            statsGraph: $('#stats-graph'),
            statsHistoryTable: $('#stats-history-table'),
            exportExcelBtn: $('#export-excel-btn'),
            // Cronómetro
            persistentTimer: $('#persistent-timer'),
            timerDisplay: $('#timer-display'),
            timerStartPauseBtn: $('#timer-start-pause'),
            timerResetBtn: $('#timer-reset'),
        };

        // --- NAVEGACIÓN SPA ---
        function navigateTo(pageId) {
            if (!pageId) return;

            // Ocultar todas las páginas
            dom.appPages.forEach(page => page.classList.add('hidden'));

            // Mostrar la página solicitada
            const targetPage = $(`#${pageId}`);
            if (targetPage) {
                targetPage.classList.remove('hidden');
                targetPage.classList.add('fade-in');
                state.currentPage = pageId;
            }

            // Actualizar enlaces activos
            dom.navLinks.forEach(link => {
                if (link.dataset.page === pageId) {
                    link.classList.add('text-blue-600', 'dark:text-blue-400', 'font-bold');
                } else {
                    link.classList.remove('text-blue-600', 'dark:text-blue-400', 'font-bold');
                }
            });

            // Ocultar menú móvil después de la navegación
            if (!dom.menuLinks.classList.contains('hidden')) {
                toggleMobileMenu();
            }
            
            // Ocultar panel de configuración
            hideSettingsPanel();

            // Volver arriba
            window.scrollTo(0, 0);
        }

        // --- RENDERIZADO DE RUTINAS (SOLO LECTURA) ---
        function renderReadOnlyRoutines() {
            Object.values(routinesDB).forEach(routine => {
                const container = dom.routineContainers[routine.id];
                if (!container) return;
                
                let html = '';
                routine.blocks.forEach(block => {
                    html += `
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-2xl font-lora font-semibold mb-6 border-b border-gray-200 dark:border-gray-700 pb-2">${block.name}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    `;
                    block.exercises.forEach(ex => {
                        html += `
                            <div class="flex flex-col bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow-md overflow-hidden">
                                <div class="p-4 flex-grow">
                                    <h4 class="font-lora font-semibold text-lg">${ex.name}</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${ex.details}</p>
                                    <p class="text-sm text-gray-700 dark:text-gray-300 mt-3">${ex.description}</p>
                                </div>
                            </div>
                        `;
                    });
                    html += `</div></div>`;
                });
                container.innerHTML = html;
            });
        }
        
        // --- LÓGICA DE SEGUIMIENTO DE RUTINA ---
        
        function startRoutineTracking(routineId) {
            const routineData = routinesDB[routineId];
            if (!routineData) return;

            // 1. Inicializar estado de la rutina actual
            const allExercises = routineData.blocks.flatMap(b => b.exercises);
            state.currentRoutine = {
                routineId: routineId,
                name: routineData.name,
                exercises: allExercises.map(ex => ({
                    ...ex,
                    completed: false,
                    sets: 0,
                    weight: ''
                }))
            };
            
            // 2. Mostrar la vista del tracker y ocultar la selección
            dom.routineSelection.classList.add('hidden');
            dom.routineTracker.classList.remove('hidden');
            dom.trackerTitle.textContent = routineData.name;
            
            // 3. Renderizar la lista de ejercicios del tracker
            renderTrackerList();
            
            // 4. Actualizar barra de progreso
            updateProgressBar();
            
            // 5. Mostrar el cronómetro persistente
            dom.persistentTimer.classList.remove('hidden');
            dom.persistentTimer.classList.add('fade-in');
        }
        
        function stopRoutineTracking() {
            // 1. Ocultar tracker, mostrar selección
            dom.routineTracker.classList.add('hidden');
            dom.routineSelection.classList.remove('hidden');
            
            // 2. Limpiar estado
            state.currentRoutine = null;
            
            // 3. Ocultar cronómetro
            dom.persistentTimer.classList.add('hidden');
            dom.persistentTimer.classList.remove('fade-in');
            
            // 4. Opcional: resetear cronómetro si se desea
            // resetTimer();
        }

        function renderTrackerList() {
            if (!state.currentRoutine) return;
            
            let html = '';
            const routineData = routinesDB[state.currentRoutine.routineId];
            
            routineData.blocks.forEach(block => {
                html += `
                    <div class="bg-white dark:bg-gray-800 p-4 md:p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-lora font-semibold mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">${block.name}</h3>
                        <div class="space-y-4">
                `;
                
                block.exercises.forEach(exData => {
                    // Encontrar el estado actual de este ejercicio
                    const exState = state.currentRoutine.exercises.find(e => e.id === exData.id);
                    
                    html += `
                        <div class="tracker-exercise p-4 rounded-lg ${exState.completed ? 'bg-green-50 dark:bg-green-900/30' : 'bg-gray-50 dark:bg-gray-700/50'} transition-colors duration-300" data-exercise-id="${exState.id}">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                <div class="mb-2 sm:mb-0 flex-grow">
                                    <h4 class="font-lora font-semibold text-lg">${exState.name}</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">${exState.details}</p>

                                    <p class="text-sm text-gray-700 dark:text-gray-300 mt-2">${exState.description}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <button class="complete-btn p-2 rounded-full ${exState.completed ? 'bg-green-500 text-white' : 'bg-gray-200 dark:bg-gray-600'}" title="Marcar como completado">
                                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mt-4">
                                <!-- Contador de Series -->
                                <div>
                                    <label class="block text-sm font-medium mb-1">Series</label>
                                    <div class="flex items-center">
                                        <button class="set-btn-minus w-8 h-8 rounded-l-md bg-gray-200 dark:bg-gray-600 font-bold hover:bg-gray-300 dark:hover:bg-gray-500">-</button>
                                        <input type="number" class="set-input w-12 h-8 text-center bg-white dark:bg-gray-700 border-t border-b border-gray-300 dark:border-gray-500" value="${exState.sets}" min="0">
                                        <button class="set-btn-plus w-8 h-8 rounded-r-md bg-gray-200 dark:bg-gray-600 font-bold hover:bg-gray-300 dark:hover:bg-gray-500">+</button>
                                    </div>
                                </div>
                                <!-- Input de Peso -->
                                <div>
                                    <label class="block text-sm font-medium mb-1">Peso (kg)</label>
                                    <input type="number" class="weight-input w-full h-8 px-2 rounded-md bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-500" value="${exState.weight}" placeholder="0">
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            });
            
            dom.trackerList.innerHTML = html;
        }
        
        function handleTrackerInteraction(e) {
            const exerciseEl = e.target.closest('.tracker-exercise');
            if (!exerciseEl) return;
            
            const exerciseId = exerciseEl.dataset.exerciseId;
            const exState = state.currentRoutine.exercises.find(e => e.id === exerciseId);
            if (!exState) return;
            
            let stateChanged = false;
            
            // Botón Completar
            if (e.target.closest('.complete-btn')) {
                exState.completed = !exState.completed;
                exerciseEl.classList.toggle('bg-green-50', exState.completed);
                exerciseEl.classList.toggle('dark:bg-green-900/30', exState.completed);
                exerciseEl.classList.toggle('bg-gray-50', !exState.completed);
                exerciseEl.classList.toggle('dark:bg-gray-700/50', !exState.completed);
                
                const btn = e.target.closest('.complete-btn');
                btn.classList.toggle('bg-green-500', exState.completed);
                btn.classList.toggle('text-white', exState.completed);
                btn.classList.toggle('bg-gray-200', !exState.completed);
                btn.classList.toggle('dark:bg-gray-600', !exState.completed);
                
                stateChanged = true;
            }
            
            // Botón Set -
            if (e.target.closest('.set-btn-minus')) {
                exState.sets = Math.max(0, exState.sets - 1);
                exerciseEl.querySelector('.set-input').value = exState.sets;
                stateChanged = true;
            }
            
            // Botón Set +
            if (e.target.closest('.set-btn-plus')) {
                exState.sets += 1;
                exerciseEl.querySelector('.set-input').value = exState.sets;
                stateChanged = true;
            }
            
            // Input Set
            if (e.target.classList.contains('set-input')) {
                exState.sets = parseInt(e.target.value) || 0;
                stateChanged = true;
            }
            
            // Input Peso
            if (e.target.classList.contains('weight-input')) {
                exState.weight = e.target.value;
                stateChanged = true;
            }
            
            if (stateChanged) {
                updateProgressBar();
            }
        }
        
        function updateProgressBar() {
            if (!state.currentRoutine) return;
            
            const total = state.currentRoutine.exercises.length;
            const completed = state.currentRoutine.exercises.filter(e => e.completed).length;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            
            dom.progressText.textContent = `${completed} / ${total} Completados`;
            dom.progressBar.style.width = `${percentage}%`;
        }
        
        function finishRoutine() {
            if (!state.currentRoutine) return;
            
            const total = state.currentRoutine.exercises.length;
            const completed = state.currentRoutine.exercises.filter(e => e.completed).length;
            
            const message = completed === total 
                ? '¡Rutina completada! ¿Guardar y salir?'
                : `Completaste ${completed} de ${total} ejercicios. ¿Guardar y salir?`;
            
            showToast(message, () => {
                // Callback de confirmación
                // 1. Guardar en el historial
                const newHistoryEntry = {
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    name: state.currentRoutine.name,
                    exercisesCompleted: completed,
                    totalExercises: total,
                    details: state.currentRoutine.exercises // Guardar detalles completos
                };
                state.stats.history.push(newHistoryEntry);
                saveStats();
                
                // 2. Mostrar toast de éxito
                showToast('¡Rutina guardada con éxito!', null, 2000);
                
                // 3. Limpiar y navegar
                stopRoutineTracking();
                navigateTo('home');
                
                // 4. Actualizar vista de estadísticas
                renderStats();
            });
        }
        
        // --- LÓGICA DEL CRONÓMETRO ---
        
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        }

        function updateTimerDisplay() {
            if (state.timer.isRunning) {
                state.timer.elapsedTime = Date.now() - state.timer.startTime;
            }
            dom.timerDisplay.textContent = formatTime(state.timer.elapsedTime);
        }

        function startTimer() {
            if (state.timer.isRunning) return;
            state.timer.isRunning = true;
            state.timer.startTime = Date.now() - state.timer.elapsedTime;
            state.timer.intervalId = setInterval(updateTimerDisplay, 1000);
            dom.timerStartPauseBtn.textContent = 'Pausar';
            dom.timerStartPauseBtn.classList.replace('bg-green-500', 'bg-yellow-500');
            dom.timerStartPauseBtn.classList.replace('dark:bg-green-600', 'dark:bg-yellow-600');
        }
        
        function pauseTimer() {
            if (!state.timer.isRunning) return;
            state.timer.isRunning = false;
            clearInterval(state.timer.intervalId);
            state.timer.intervalId = null;
            // elapsedTime ya está actualizado por el último tick del intervalo
            dom.timerStartPauseBtn.textContent = 'Iniciar';
            dom.timerStartPauseBtn.classList.replace('bg-yellow-500', 'bg-green-500');
            dom.timerStartPauseBtn.classList.replace('dark:bg-yellow-600', 'dark:bg-green-600');
        }
        
        function resetTimer() {
            pauseTimer();
            state.timer.elapsedTime = 0;
            updateTimerDisplay();
        }

        // --- LÓGICA DE ESTADÍSTICAS ---
        
        function loadStats() {
            const savedStats = localStorage.getItem('anzoStats');
            if (savedStats) {
                state.stats = JSON.parse(savedStats);
                // Asegurarse de que el historial sea un array
                if (!state.stats.history) {
                    state.stats.history = [];
                }
            }
        }
        
        function saveStats() {
            localStorage.setItem('anzoStats', JSON.stringify(state.stats));
        }
        
        function renderStats() {
            // 1. Calcular contador semanal
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1))); // Lunes
            startOfWeek.setHours(0, 0, 0, 0);
            
            const weeklyWorkouts = state.stats.history.filter(entry => {
                return new Date(entry.date) >= startOfWeek;
            });
            dom.statsWeeklyCount.textContent = weeklyWorkouts.length;
            
            // 2. Renderizar historial
            if (state.stats.history.length === 0) {
                dom.statsHistoryTable.innerHTML = `
                    <tr><td colspan="3" class="text-center py-6 text-gray-500 dark:text-gray-400">No hay rutinas completadas.</td></tr>
                `;
            } else {
                let historyHtml = '';
                // Mostrar las más recientes primero
                [...state.stats.history].reverse().forEach(entry => {
                    const date = new Date(entry.date);
                    historyHtml += `
                        <tr class="border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                            <td class="py-3 px-4">${date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })}</td>
                            <td class="py-3 px-4">${entry.name}</td>
                            <td class="py-3 px-4">${entry.exercisesCompleted} / ${entry.totalExercises}</td>
                        </tr>
                    `;
                });
                dom.statsHistoryTable.innerHTML = historyHtml;
            }
            
            // 3. Renderizar gráfico simple
            const totals = routinesDB ? { chest: 0, back: 0, leg: 0, shoulders: 0 } : {};
            let maxCount = 0;
            state.stats.history.forEach(entry => {
                const id = entry.routineId || routinesDB[Object.keys(routinesDB).find(key => routinesDB[key].name === entry.name)]?.id;
                if (id && totals.hasOwnProperty(id)) {
                    totals[id]++;
                    if (totals[id] > maxCount) maxCount = totals[id];
                }
            });

            if (maxCount === 0) {
                 dom.statsGraph.innerHTML = `<p class="text-gray-500 dark:text-gray-400">Aún no hay datos para mostrar.</p>`;
            } else {
                let graphHtml = '';
                Object.entries(totals).forEach(([id, count]) => {
                    const percentage = (count / maxCount) * 100;
                    graphHtml += `
                        <div class="flex items-center">
                            <span class="w-24 text-sm font-medium text-gray-600 dark:text-gray-400">${routinesDB[id].name.split(' ')[0]}</span>
                            <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-4 mr-2">
                                <div class="bg-blue-600 h-4 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                            <span class="w-8 text-sm font-bold">${count}</span>
                        </div>
                    `;
                });
                dom.statsGraph.innerHTML = graphHtml;
            }
        }
        
        function exportStatsToExcel() {
            if (state.stats.history.length === 0) {
                showToast('No hay estadísticas para exportar', null, 2000);
                return;
            }
            
            // Preparar datos para Excel
            const dataToExport = state.stats.history.map(entry => {
                const date = new Date(entry.date);
                return {
                    'Fecha': date.toLocaleDateString('es-ES'),
                    'Hora': date.toLocaleTimeString('es-ES'),
                    'Rutina': entry.name,
                    'Completados': entry.exercisesCompleted,
                    'Total': entry.totalExercises,
                    // Opcional: añadir detalles
                    // 'Detalles': JSON.stringify(entry.details.filter(ex => ex.sets > 0 || ex.weight !== ''))
                };
            });

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Historial de Rutinas');
            
            // Auto-ajustar columnas (simple)
            const wscols = [
                { wch: 12 },
                { wch: 10 },
                { wch: 25 },
                { wch: 12 },
                { wch: 10 },
                // { wch: 50 } 
            ];
            worksheet['!cols'] = wscols;

            // Descargar el archivo
            XLSX.writeFile(workbook, 'AnzoStyle_Estadisticas.xlsx');
            showToast('Exportando estadísticas...', null, 2000);
        }
        
        function resetStats() {
            showToast('¿Seguro que quieres borrar TODO el historial?', () => {
                state.stats.history = [];
                saveStats();
                renderStats();
                showToast('Estadísticas reiniciadas.', null, 2000);
            });
        }
        

        // --- LÓGICA DE CONFIGURACIÓN Y UI ---
        
        function toggleMobileMenu() {
            const isHidden = dom.menuLinks.classList.contains('hidden');
            if (isHidden) {
                dom.menuLinks.classList.remove('hidden');
                dom.menuLinks.style.maxHeight = dom.menuLinks.scrollHeight + "px";
                dom.menuIconOpen.classList.add('hidden');
                dom.menuIconClose.classList.remove('hidden');
            } else {
                dom.menuLinks.style.maxHeight = "0px";
                dom.menuIconOpen.classList.remove('hidden');
                dom.menuIconClose.classList.add('hidden');
                // Esperar a que la transición termine para ocultarlo
                setTimeout(() => {
                    dom.menuLinks.classList.add('hidden');
                }, 300);
            }
        }
        
        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            dom.html.classList.toggle('dark', state.darkMode);
            localStorage.setItem('anzoDarkMode', state.darkMode);
            
            // Actualizar el botón toggle
            const toggleCircle = dom.darkModeToggle.querySelector('span:last-child');
            if (state.darkMode) {
                toggleCircle.style.transform = 'translateX(1.25rem)'; // 1.25rem = 5 * w-5
            } else {
                toggleCircle.style.transform = 'translateX(0)';
            }
        }

        function loadPreferences() {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const savedMode = localStorage.getItem('anzoDarkMode');
            
            if (savedMode === 'true') {
                state.darkMode = true;
            } else if (savedMode === 'false') {
                state.darkMode = false;
            } else {
                state.darkMode = prefersDark;
            }
            
            dom.html.classList.toggle('dark', state.darkMode);
            
            // Sincronizar el botón
            const toggleCircle = dom.darkModeToggle.querySelector('span:last-child');
            if (state.darkMode) {
                dom.darkModeToggle.classList.add('bg-blue-600');
                dom.darkModeToggle.classList.remove('bg-gray-200');
                toggleCircle.style.transform = 'translateX(1.25rem)';
            } else {
                dom.darkModeToggle.classList.add('bg-gray-200');
                dom.darkModeToggle.classList.remove('bg-blue-600');
                toggleCircle.style.transform = 'translateX(0)';
            }
        }
        
        function toggleSettingsPanel() {
            dom.settingsPanel.classList.toggle('hidden');
            if (!dom.settingsPanel.classList.contains('hidden')) {
                dom.settingsPanel.classList.add('fade-in');
            }
        }
        
        function hideSettingsPanel() {
            dom.settingsPanel.classList.add('hidden');
        }

        function handleScroll() {
            if (window.scrollY > 300) {
                dom.scrollToTopBtn.classList.remove('hidden', 'opacity-0');
            } else {
                dom.scrollToTopBtn.classList.add('opacity-0');
                // Esperar a que la transición termine para ocultarlo
                setTimeout(() => {
                    if (window.scrollY <= 300) { // Comprobar de nuevo
                        dom.scrollToTopBtn.classList.add('hidden');
                    }
                }, 300);
            }
        }
        
        let toastTimer = null;
        function showToast(message, confirmCallback = null, duration = 3000) {
            clearTimeout(toastTimer);
            dom.toastMessage.textContent = message;
            dom.toastActions.innerHTML = '';
            
            if (confirmCallback) {
                // Modo confirmación
                const yesBtn = document.createElement('button');
                yesBtn.className = 'px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600';
                yesBtn.textContent = 'Sí';
                yesBtn.onclick = () => {
                    confirmCallback();
                    hideToast();
                };
                
                const noBtn = document.createElement('button');
                noBtn.className = 'px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600';
                noBtn.textContent = 'No';
                noBtn.onclick = hideToast;
                
                dom.toastActions.append(yesBtn, noBtn);
                
            } else {
                // Modo notificación
                toastTimer = setTimeout(hideToast, duration);
            }
            
            dom.toast.classList.remove('hidden');
            setTimeout(() => {
                dom.toast.classList.remove('translate-y-10', 'opacity-0');
            }, 10);
        }
        
        function hideToast() {
            clearTimeout(toastTimer);
            dom.toast.classList.add('translate-y-10', 'opacity-0');
            setTimeout(() => {
                dom.toast.classList.add('hidden');
            }, 300);
        }

        // --- INICIALIZACIÓN ---
        function initApp() {
            // Cargar preferencias y datos
            loadPreferences();
            loadStats();
            
            // Renderizar contenido estático
            renderReadOnlyRoutines();
            renderStats();

            // Configurar Listeners de Navegación
            dom.navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateTo(link.dataset.page);
                });
            });
            
            // Listeners de UI
            dom.menuToggle.addEventListener('click', toggleMobileMenu);
            dom.settingsToggle.addEventListener('click', toggleSettingsPanel);
            dom.darkModeToggle.addEventListener('click', toggleDarkMode);
            dom.resetStatsBtn.addEventListener('click', resetStats);
            dom.scrollToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
            window.addEventListener('scroll', handleScroll);
            
            // Ocultar panel de config al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!dom.settingsPanel.classList.contains('hidden') && 
                    !dom.settingsPanel.contains(e.target) && 
                    !dom.settingsToggle.contains(e.target)) {
                    hideSettingsPanel();
                }
            });

            // Listeners de "Comenzar Rutina"
            dom.selectRoutineBtns.forEach(btn => {
                btn.addEventListener('click', () => startRoutineTracking(btn.dataset.routine));
            });
            dom.backToSelectionBtn.addEventListener('click', stopRoutineTracking);
            
            // Listeners del Tracker (usando delegación de eventos)
            dom.trackerList.addEventListener('click', handleTrackerInteraction);
            dom.trackerList.addEventListener('change', handleTrackerInteraction); // Para inputs
            
            dom.finishRoutineBtn.addEventListener('click', finishRoutine);
            
            // Listeners de Estadísticas
            dom.exportExcelBtn.addEventListener('click', exportStatsToExcel);
            
            // Listeners del Cronómetro
            dom.timerStartPauseBtn.addEventListener('click', () => {
                state.timer.isRunning ? pauseTimer() : startTimer();
            });
            dom.timerResetBtn.addEventListener('click', resetTimer);

            // Mostrar página de inicio y ocultar loader
            navigateTo('home');
            setTimeout(() => {
                dom.loader.style.transition = 'opacity 0.5s ease-out';
                dom.loader.style.opacity = '0';
                setTimeout(() => dom.loader.classList.add('hidden'), 500);
            }, 1000); // Simular tiempo de carga
        }

        // Iniciar la aplicación
        document.addEventListener('DOMContentLoaded', initApp);
        
    </script>

</body>
</html>
