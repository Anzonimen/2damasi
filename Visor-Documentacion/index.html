<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalDrive OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- FIREBASE COMPAT SDKs (Firestore Version - Estable) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        drive: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' },
                        darkbg: '#1e1e1e',
                        darkpanel: '#252526'
                    }
                }
            }
        }
    </script>
    <style>
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
        .list-view { display: flex; flex-direction: column; gap: 0.5rem; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }db
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .icon { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        #drop-zone { transition: all 0.3s ease; pointer-events: none; opacity: 0; }
        #drop-zone.active { pointer-events: all; opacity: 1; backdrop-filter: blur(4px); }
        .code-keyword { color: #c678dd; font-weight: bold; }
        .code-string { color: #98c379; }
        .code-function { color: #61afef; }
        .code-comment { color: #5c6370; font-style: italic; }
        #new-menu:not(.hidden), #sort-menu:not(.hidden) { animation: fadeIn 0.1s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .toast { transition: all 0.3s ease; transform: translateX(100%); opacity: 0; }
        .toast.show { transform: translateX(0); opacity: 1; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen overflow-hidden transition-colors duration-300" onclick="window.handleClickOutside(event)">

    <!-- App Container -->
    <div id="app" class="flex h-full">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-white dark:bg-darkpanel border-r dark:border-gray-700 flex flex-col transition-colors duration-300 hidden md:flex">
            <div class="p-6 flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg shadow-lg">
                    <svg class="icon w-6 h-6" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                </div>
                <h1 class="font-bold text-xl tracking-tight dark:text-white">LocalDrive</h1>
            </div>

            <div class="px-4 mb-4 relative z-20">
                <button id="new-btn" onclick="window.toggleNewMenu(event)" class="w-full bg-white dark:bg-gray-700 dark:text-white border dark:border-gray-600 hover:shadow-md py-3 rounded-full flex items-center justify-center gap-2 transition-all font-medium text-blue-600 dark:text-blue-400">
                    <svg class="icon w-5 h-5" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></svg>
                    Nuevo
                </button>
                <!-- Menú Desplegable -->
                <div id="new-menu" class="hidden absolute top-full left-4 right-4 mt-2 bg-white dark:bg-gray-800 rounded-xl shadow-xl border dark:border-gray-700 overflow-hidden text-sm font-medium text-gray-700 dark:text-gray-200 z-50">
                    <button onclick="window.triggerUpload('file')" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-3">
                        <svg class="icon w-5 h-5 text-gray-500" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg> Subir Archivo
                    </button>
                    <button onclick="window.triggerUpload('folder')" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-3">
                        <svg class="icon w-5 h-5 text-gray-500" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg> Subir Carpeta
                    </button>
                    <div class="border-t dark:border-gray-700 my-1"></div>
                    <button onclick="window.openInputModal('create')" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-3">
                        <svg class="icon w-5 h-5 text-gray-500" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg> Nueva Carpeta
                    </button>
                </div>
                <!-- Inputs ocultos -->
                <input type="file" id="fileInput" multiple class="hidden" onchange="window.handleFileSelect(event)">
                <input type="file" id="folderInput" webkitdirectory directory multiple class="hidden" onchange="window.handleFileSelect(event)">
            </div>

            <nav class="flex-1 overflow-y-auto px-4 space-y-1" id="nav-links">
                <!-- Seccion Local -->
                <div class="px-2 mt-2 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Local</div>
                <!-- FIXED: Changed default classes to match inactive state so it looks correct when not selected in dark mode -->
                <button onclick="window.navigate('root')" id="nav-root" class="w-full flex items-center gap-3 px-4 py-2 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800 transition-colors">
                    <svg class="icon w-5 h-5" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg> Mi Unidad
                </button>
                <button onclick="window.navigate('trash')" id="nav-trash" class="w-full flex items-center gap-3 px-4 py-2 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800 transition-colors">
                    <svg class="icon w-5 h-5" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg> Papelera
                </button>

                <!-- Seccion Nube -->
                <div class="px-2 mt-6 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Nube (Firestore)</div>
                <button onclick="window.navigate('cloud')" id="nav-cloud" class="w-full flex items-center gap-3 px-4 py-2 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800 transition-colors">
                    <svg class="icon w-5 h-5 text-orange-500" viewBox="0 0 24 24"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg> Archivos en Nube
                </button>

                <!-- Seccion Sistema -->
                <div class="px-2 mt-6 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Sistema</div>
                <button onclick="window.showDashboard()" id="nav-stats" class="w-full flex items-center gap-3 px-4 py-2 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800 transition-colors">
                    <svg class="icon w-5 h-5" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg> Estadísticas
                </button>
            </nav>

            <div class="px-4 pb-2">
                <div class="flex items-center gap-2 p-2 rounded-lg bg-gray-50 dark:bg-gray-800 border dark:border-gray-700">
                    <input type="checkbox" id="auto-upload-check" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" onchange="window.toggleAutoUpload(this.checked)">
                    <label for="auto-upload-check" class="text-xs font-medium text-gray-700 dark:text-gray-300 cursor-pointer">Auto-subir a Nube</label>
                </div>
            </div>

            <div class="p-4 border-t dark:border-gray-700">
                <div class="mb-2 flex justify-between text-xs text-gray-500 dark:text-gray-400">
                    <span>Almacenamiento Local</span>
                    <span id="storage-text">Calculando...</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-700">
                    <div id="storage-bar" class="bg-blue-600 h-1.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-white dark:bg-darkbg transition-colors duration-300 relative">
            
            <!-- Header -->
            <header class="h-16 border-b dark:border-gray-700 flex items-center justify-between px-6 bg-white dark:bg-darkbg">
                <div class="flex items-center gap-4 flex-1">
                    <button class="md:hidden p-2 text-gray-600" onclick="document.querySelector('aside').classList.toggle('hidden')">
                        <svg class="icon w-6 h-6" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <!-- Search -->
                    <div class="relative w-full max-w-2xl">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="icon w-5 h-5 text-gray-400" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        </div>
                        <input type="text" id="searchInput" oninput="window.handleSearch(this.value)" placeholder="Buscar en Drive..." class="w-full bg-gray-100 dark:bg-gray-800 dark:text-white border-none rounded-lg pl-10 py-2.5 focus:ring-2 focus:ring-blue-500 transition-all">
                    </div>
                </div>

                <div class="flex items-center gap-3 ml-4 relative">
                    
                    <!-- Firebase Status Dot -->
                    <div class="relative group flex items-center">
                        <div id="firebase-status-dot" class="w-3 h-3 rounded-full bg-red-500 border border-white dark:border-gray-800 shadow-sm" title="Desconectado"></div>
                        <span id="firebase-status-text" class="absolute top-full right-0 mt-2 text-xs bg-black text-white px-2 py-1 rounded hidden group-hover:block whitespace-nowrap z-50">Desconectado</span>
                    </div>

                    <button onclick="window.toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300" title="Tema">
                        <svg class="icon w-6 h-6" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    </button>

                    <!-- Botón de Ordenar -->
                    <div class="relative">
                        <button id="sort-btn" onclick="window.toggleSortMenu(event)" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300" title="Ordenar">
                            <svg class="icon w-6 h-6" viewBox="0 0 24 24"><line x1="21" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="21" y1="18" x2="3" y2="18"></line></svg>
                        </button>
                        <!-- Dropdown de Ordenación -->
                        <div id="sort-menu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-xl shadow-xl border dark:border-gray-700 z-50 overflow-hidden">
                            <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-50 dark:bg-gray-900">Ordenar por</div>
                            <button onclick="window.setSort('name')" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm flex justify-between items-center dark:text-gray-200">
                                Nombre <span id="check-name" class="text-blue-500 opacity-0">✓</span>
                            </button>
                            <button onclick="window.setSort('createdAt')" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm flex justify-between items-center dark:text-gray-200">
                                Fecha <span id="check-createdAt" class="text-blue-500 opacity-0">✓</span>
                            </button>
                            <button onclick="window.setSort('size')" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm flex justify-between items-center dark:text-gray-200">
                                Tamaño <span id="check-size" class="text-blue-500 opacity-0">✓</span>
                            </button>
                            <button onclick="window.setSort('extension')" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm flex justify-between items-center dark:text-gray-200">
                                Tipo <span id="check-extension" class="text-blue-500 opacity-0">✓</span>
                            </button>
                            <div class="border-t dark:border-gray-700 my-1"></div>
                            <button onclick="window.toggleSortOrder()" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm flex items-center gap-2 dark:text-gray-200">
                                <span id="sort-order-icon">⬇️</span> <span id="sort-order-text">Descendente</span>
                            </button>
                        </div>
                    </div>

                    <button onclick="window.toggleLayout()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300" title="Vista">
                        <svg id="layoutIcon" class="icon w-6 h-6" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    </button>
                    <button onclick="window.exportData()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300" title="Backup JSON">
                        <svg class="icon w-6 h-6" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    </button>
                </div>
            </header>

            <!-- Breadcrumbs & Toolbar -->
            <div class="h-12 border-b dark:border-gray-700 flex items-center px-6 gap-4 text-sm text-gray-600 dark:text-gray-300 overflow-x-auto">
                <div id="breadcrumbs" class="flex items-center gap-2 whitespace-nowrap">
                    <!-- Dinámico -->
                </div>
                <div class="ml-auto flex gap-2">
                     <button id="add-folder-btn" onclick="window.openInputModal('create')" class="hover:bg-gray-100 dark:hover:bg-gray-700 px-2 py-1 rounded">+ Carpeta</button>
                </div>
            </div>

            <!-- Content Area -->
            <div id="content-area" class="flex-1 overflow-y-auto p-6 relative" oncontextmenu="return false;">
                
                <!-- Dashboard View -->
                <div id="dashboard-view" class="hidden space-y-6">
                    <h2 class="text-2xl font-bold dark:text-white">Estadísticas</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-blue-100 dark:bg-blue-900 p-6 rounded-xl"><h3 class="font-semibold text-blue-800 dark:text-blue-100">Total</h3><p id="stat-count" class="text-3xl font-bold mt-2">0</p></div>
                        <div class="bg-green-100 dark:bg-green-900 p-6 rounded-xl"><h3 class="font-semibold text-green-800 dark:text-green-100">Uso</h3><p id="stat-size" class="text-3xl font-bold mt-2">0 MB</p></div>
                        <div class="bg-purple-100 dark:bg-purple-900 p-6 rounded-xl"><h3 class="font-semibold text-purple-800 dark:text-purple-100">Papelera</h3><p id="stat-trash" class="text-3xl font-bold mt-2">0</p></div>
                    </div>
                    <div class="h-64 bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border dark:border-gray-700"><canvas id="fileTypeChart"></canvas></div>
                </div>

                <!-- Files View -->
                <div id="file-container" class="folder-grid pb-20">
                    <!-- Los archivos se renderizan aquí -->
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                    <svg class="w-32 h-32 mb-4 opacity-50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                    <p class="text-lg font-medium">Esta carpeta está vacía</p>
                    <p class="text-sm">Arrastra archivos aquí o usa el botón Nuevo</p>
                </div>

                <!-- Loading State for Cloud -->
                <div id="cloud-loading" class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-500">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                    <p>Cargando archivos de Firestore...</p>
                </div>
            </div>

            <!-- Drag Overlay -->
            <div id="drop-zone" class="absolute inset-0 bg-blue-500/20 z-50 flex items-center justify-center border-4 border-blue-500 border-dashed m-4 rounded-xl">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl text-center pointer-events-none">
                    <svg class="icon w-12 h-12 mx-auto text-blue-500 mb-2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    <h3 class="text-xl font-bold dark:text-white">Suelta para subir a Local</h3>
                </div>
            </div>

        </main>
    </div>

    <!-- Modals & Menus -->
    
    <!-- Input Modal -->
    <div id="input-modal" class="fixed inset-0 bg-black/50 z-[80] hidden flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm mx-4 p-6">
            <h3 id="input-modal-title" class="text-lg font-bold mb-4 dark:text-white">Título</h3>
            <input type="text" id="input-modal-value" class="w-full border dark:border-gray-600 rounded p-2 mb-4 dark:bg-gray-700 dark:text-white" onkeyup="if(event.key==='Enter') window.submitInputModal()">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('input-modal').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancelar</button>
                <button onclick="window.submitInputModal()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/50 z-[80] hidden flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm mx-4 p-6">
            <h3 class="text-lg font-bold mb-2 dark:text-white">¿Estás seguro?</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-6">Esta acción no se puede deshacer.</p>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('confirm-modal').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancelar</button>
                <button onclick="window.submitConfirmModal()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Conflict Modal -->
    <div id="conflict-modal" class="hidden fixed inset-0 bg-black/50 z-[90] flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6 m-4">
            <h3 class="text-lg font-bold mb-2 dark:text-white">Conflicto de archivos</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-4 text-sm">El archivo <span id="conflict-filename" class="font-bold"></span> ya existe en esta ubicación.</p>
            
            <div class="flex flex-col gap-2">
                <button onclick="window.resolveConflict('replace')" class="flex items-center gap-3 p-3 rounded-lg border hover:bg-gray-50 dark:border-gray-600 dark:hover:bg-gray-700 transition-colors">
                    <div class="bg-blue-100 text-blue-600 p-2 rounded-full shrink-0"><svg class="icon w-5 h-5" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg></div>
                    <div class="text-left">
                        <div class="font-medium dark:text-white text-sm">Reemplazar</div>
                        <div class="text-xs text-gray-500">Sobrescribir el archivo existente</div>
                    </div>
                </button>
                <button onclick="window.resolveConflict('rename')" class="flex items-center gap-3 p-3 rounded-lg border hover:bg-gray-50 dark:border-gray-600 dark:hover:bg-gray-700 transition-colors">
                    <div class="bg-yellow-100 text-yellow-600 p-2 rounded-full shrink-0"><svg class="icon w-5 h-5" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></div>
                    <div class="text-left">
                        <div class="font-medium dark:text-white text-sm">Renombrar</div>
                        <div class="text-xs text-gray-500">Elegir un nuevo nombre</div>
                    </div>
                </button>
                <button onclick="window.resolveConflict('keep')" class="flex items-center gap-3 p-3 rounded-lg border hover:bg-gray-50 dark:border-gray-600 dark:hover:bg-gray-700 transition-colors">
                    <div class="bg-gray-100 text-gray-600 p-2 rounded-full shrink-0"><svg class="icon w-5 h-5" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg></div>
                    <div class="text-left">
                        <div class="font-medium dark:text-white text-sm">Subir copia (Sin cambiar)</div>
                        <div class="text-xs text-gray-500">Conservar ambos archivos</div>
                    </div>
                </button>
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="window.resolveConflict('cancel')" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-sm font-medium">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Move Modal -->
    <div id="move-modal" class="fixed inset-0 bg-black/50 z-[70] hidden flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4 flex flex-col max-h-[80vh]">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h3 class="font-bold text-lg dark:text-white">Mover a...</h3>
                <button onclick="document.getElementById('move-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700"><svg class="icon w-6 h-6" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            <div id="move-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 bg-black/90 z-[60] hidden flex flex-col">
        <div class="h-14 flex items-center justify-between px-4 text-white bg-black">
            <h3 id="preview-title" class="truncate font-medium max-w-md">Preview</h3>
            <div class="flex gap-4">
                <button onclick="window.downloadCurrentPreview()" class="hover:text-blue-400"><svg class="icon w-6 h-6" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></button>
                <button onclick="window.closePreview()" class="hover:text-red-400"><svg class="icon w-6 h-6" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
        </div>
        <div class="flex-1 overflow-auto flex items-center justify-center p-4" id="preview-content"></div>
        <div id="audio-controls" class="hidden h-20 bg-gray-900 text-white flex items-center px-6 gap-4">
            <button id="audio-play-btn" class="p-2 bg-white text-black rounded-full"><svg class="icon w-4 h-4" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button>
            <div class="flex-1"><div class="flex justify-between text-xs text-gray-400 mb-1"><span id="audio-current">0:00</span><span id="audio-total">0:00</span></div><input type="range" id="audio-slider" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"></div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu" class="fixed z-50 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl border dark:border-gray-700 hidden py-1 text-sm font-medium text-gray-700 dark:text-gray-200">
        <!-- Default Actions -->
        <div id="ctx-default-actions">
            <button onclick="window.ctxAction('open')" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">Abrir</button>
            <button onclick="window.ctxAction('uploadCloud')" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-blue-600 dark:text-blue-400 flex items-center gap-2"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg> Subir a Nube</button>
            <button onclick="window.ctxAction('rename')" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">Renombrar</button>
            <button onclick="window.ctxAction('move')" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">Mover a...</button>
            <div class="border-t dark:border-gray-700 my-1"></div>
            <button onclick="window.ctxAction('delete')" class="w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 dark:text-red-400 dark:hover:bg-gray-700">Eliminar</button>
        </div>
        
        <!-- Cloud Specific Actions -->
        <div id="ctx-cloud-actions" class="hidden">
            <button onclick="window.ctxAction('open')" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">Ver</button>
            <button onclick="window.ctxAction('downloadToLocal')" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-green-600 dark:text-green-400">Importar a Local</button>
            <div class="border-t dark:border-gray-700 my-1"></div>
            <button onclick="window.ctxAction('deleteCloud')" class="w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 dark:text-red-400 dark:hover:bg-gray-700">Eliminar de Nube</button>
        </div>

        <button onclick="window.ctxAction('restore')" id="ctx-restore" class="w-full text-left px-4 py-2 hover:bg-green-50 text-green-600 hidden">Restaurar</button>
        <button onclick="window.ctxAction('permDelete')" id="ctx-perm-delete" class="w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 hidden">Borrar definitivamente</button>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-[100] flex flex-col gap-2"></div>

    <script>
        // FIREBASE CONFIG & INIT (COMPAT STYLE)
        const firebaseConfig = {
            apiKey: "AIzaSyA-zGWgFEIdwuxWlNQqxWI7azMSqUAUJSU",
            authDomain: "visordocumentos-efb6c.firebaseapp.com",
            projectId: "visordocumentos-efb6c",
            storageBucket: "visordocumentos-efb6c.firebasestorage.app",
            messagingSenderId: "799273540976",
            appId: "1:799273540976:web:dd987a3f827d9f100f43b5",
            measurementId: "G-FC703RL3NH"
        };

        let auth, firestore, currentUser;
        let autoUpload = false;
        let authError = null;

        // Init Firebase
        try {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                firestore = firebase.firestore();

                // Auth Listener
                auth.onAuthStateChanged((user) => {
                    console.log("Auth State Changed:", user ? "User Logged In" : "User Logged Out");
                    currentUser = user;
                    updateStatusDot(user ? 'connected' : 'disconnected');
                    if(user && AppState.viewModeContext === 'cloud') {
                        window.loadCloudContent();
                    }
                });

                console.log("Intentando Login Anónimo...");
                auth.signInAnonymously().then(() => {
                     console.log("Login Anónimo Exitoso");
                }).catch((error) => {
                    console.error("Auth Error:", error);
                    authError = error;
                    updateStatusDot('error');
                    setTimeout(() => showToast(`Error Auth: ${error.code} - ${error.message}`, "error"), 1000);
                    if(AppState.viewModeContext === 'cloud') window.loadCloudContent();
                });

                // Watchdog para avisar si tarda mucho
                setTimeout(() => {
                    const dot = document.getElementById('firebase-status-dot');
                    if (dot && dot.classList.contains('bg-red-500')) {
                        showToast("La conexión a Firebase está tardando demasiado.", "error");
                        console.warn("CHECKLIST DE DEBUG:");
                        console.warn("1. ¿Has habilitado 'Anonymous' en Authentication > Sign-in method?");
                        console.warn("2. ¿Tu 'projectId' en la config es correcto?");
                        console.warn("3. ¿Tienes conexión a internet?");
                    }
                }, 10000); // 10 segundos

            } else {
                console.error("Firebase SDK not loaded");
                updateStatusDot('error');
            }
        } catch(e) {
            console.error("Firebase Init Error:", e);
            updateStatusDot('error');
        }

        function updateStatusDot(status) {
            const dot = document.getElementById('firebase-status-dot');
            const txt = document.getElementById('firebase-status-text');
            if (!dot || !txt) return;
            
            if(status === 'connected') {
                dot.className = "w-3 h-3 rounded-full bg-green-500 border border-white dark:border-gray-800 shadow-sm animate-pulse";
                const msg = "Conectado a Nube (Firestore)";
                txt.textContent = msg;
                dot.title = msg; // Actualiza el tooltip nativo
            } else if (status === 'uploading') {
                dot.className = "w-3 h-3 rounded-full bg-yellow-400 border border-white dark:border-gray-800 shadow-sm animate-bounce";
                const msg = "Subiendo...";
                txt.textContent = msg;
                dot.title = msg; // Actualiza el tooltip nativo
            } else {
                dot.className = "w-3 h-3 rounded-full bg-red-500 border border-white dark:border-gray-800 shadow-sm";
                const msg = status === 'error' ? "Error de Conexión" : "Desconectado";
                txt.textContent = msg;
                dot.title = msg; // Actualiza el tooltip nativo
            }
        }

        // USING FIRESTORE TO STORE FILES (BASE64)
        async function uploadFileToFirebase(fileObj) {
            if(!currentUser) {
                showToast("No conectado a Firebase. Revisa la consola.", "error");
                return;
            }
            
            // Limit check: Firestore documents max 1MB
            if (fileObj.size > 950000) {
                showToast("Archivo muy grande para Firestore (Max ~950KB)", "error");
                return;
            }

            updateStatusDot('uploading');
            showToast(`Subiendo ${fileObj.name}...`, "info");

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result;
                
                firestore.collection('uploads').add({
                    userId: currentUser.uid,
                    name: fileObj.name,
                    size: fileObj.size,
                    type: fileObj.type,
                    data: base64Data, // Storing file content as string
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    showToast(`${fileObj.name} subido correctamente`, "success");
                    updateStatusDot('connected');
                    if(AppState.viewModeContext === 'cloud') window.loadCloudContent();
                }).catch((error) => {
                    console.error("Upload Error:", error);
                    showToast(`Error al subir: ${error.code}`, "error");
                    updateStatusDot('connected');
                });
            };
            reader.readAsDataURL(fileObj.content);
        }

        window.loadCloudContent = function() {
            if(!currentUser) {
                document.getElementById('cloud-loading').classList.add('hidden');
                let errorMsg = "No conectado a Firebase";
                if (authError) errorMsg += `<br><span class="text-sm text-red-400 mt-2 block">Error: ${authError.code}</span>`;
                
                document.getElementById('empty-state').innerHTML = `
                    <div class="text-center p-6 bg-red-50 dark:bg-red-900/20 rounded-xl">
                        <svg class="w-16 h-16 mx-auto text-red-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        <p class="text-red-600 font-bold">${errorMsg}</p>
                        <p class="text-xs text-gray-500 mt-2">Asegúrate de habilitar "Anonymous Auth" en la consola de Firebase.</p>
                    </div>
                `;
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }

            document.getElementById('cloud-loading').classList.remove('hidden');
            document.getElementById('file-container').innerHTML = '';
            document.getElementById('empty-state').classList.add('hidden');

            firestore.collection('uploads')
                .where('userId', '==', currentUser.uid)
                // .orderBy('createdAt', 'desc') // REMOVED to avoid index error
                .get()
                .then((querySnapshot) => {
                    const cloudFiles = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        cloudFiles.push({
                            id: doc.id, 
                            name: data.name,
                            size: data.size,
                            type: data.type,
                            data: data.data, 
                            isCloud: true,
                            createdAt: data.createdAt // Capture timestamp
                        });
                    });
                    // Client-side sorting
                    cloudFiles.sort((a, b) => {
                        const tA = a.createdAt && a.createdAt.toMillis ? a.createdAt.toMillis() : 0;
                        const tB = b.createdAt && b.createdAt.toMillis ? b.createdAt.toMillis() : 0;
                        return tB - tA;
                    });
                    
                    AppState.cloudFiles = cloudFiles;
                    renderCloudFiles();
                })
                .catch((error) => {
                    console.error("Cloud List Error", error);
                    showToast("Error listando nube: " + error.code, "error");
                })
                .finally(() => {
                    document.getElementById('cloud-loading').classList.add('hidden');
                });
        }

        function renderCloudFiles() {
            const container = document.getElementById('file-container');
            container.innerHTML = '';
            
            if (AppState.cloudFiles.length === 0) {
                document.getElementById('empty-state').innerHTML = `
                    <svg class="w-32 h-32 mb-4 opacity-50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>
                    <p class="text-lg font-medium">Nube vacía</p>
                    <p class="text-sm">Sube archivos desde "Local" para verlos aquí</p>
                `;
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }

            document.getElementById('empty-state').classList.add('hidden');
            
            AppState.cloudFiles.forEach(file => {
                const div = document.createElement('div');
                const isGrid = AppState.viewMode === 'grid';
                
                div.className = isGrid 
                    ? `group relative bg-white dark:bg-gray-800 p-4 rounded-xl border border-orange-200 dark:border-orange-900/30 hover:shadow-lg transition-all cursor-pointer flex flex-col items-center gap-3 select-none`
                    : `group relative bg-white dark:bg-gray-800 p-3 rounded-lg border border-orange-200 dark:border-orange-900/30 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all cursor-pointer flex items-center gap-4 select-none`;
                
                const icon = getFileIcon(file.name);
                const cloudBadge = `<div class="absolute top-2 left-2 bg-orange-100 text-orange-600 rounded-full p-1"><svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg></div>`;
                const menuBtn = `<button onclick="window.openMenuFor(event, '${file.id}', 'cloudFile')" class="absolute top-2 right-2 p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 opacity-0 group-hover:opacity-100 transition-opacity z-10"><svg class="w-5 h-5 text-gray-500" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg></button>`;

                if (isGrid) {
                    div.innerHTML = `${cloudBadge}${menuBtn}<div class="w-full flex justify-center pointer-events-none">${icon}</div><div class="text-center w-full overflow-hidden"><p class="text-sm font-medium text-gray-700 dark:text-gray-200 truncate w-full" title="${file.name}">${file.name}</p><p class="text-xs text-gray-400 mt-1">${formatSize(file.size)}</p></div>`;
                } else {
                    div.innerHTML = `<div class="flex-shrink-0 relative">${icon.replace('w-12 h-12', 'w-8 h-8')}</div><div class="flex-1 min-w-0"><p class="text-sm font-medium text-gray-700 dark:text-gray-200 truncate">${file.name}</p></div><div class="text-xs text-gray-400 w-24 text-right mr-8">${formatSize(file.size)}</div>${menuBtn.replace('top-2 right-2', 'top-1/2 -translate-y-1/2 right-2')}`;
                }

                div.ondblclick = () => window.previewCloudFile(file);
                div.oncontextmenu = (e) => window.showContextMenu(e, file, 'cloudFile');
                container.appendChild(div);
            });
            container.className = AppState.viewMode === 'grid' ? 'folder-grid pb-20 p-2' : 'list-view pb-20 p-2';
        }

        window.previewCloudFile = function(file) {
            showToast("Abriendo desde nube...", "info");
            // Base64 to Blob
            fetch(file.data)
            .then(res => res.blob())
            .then(blob => {
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
            });
        }

        window.deleteCloudFile = function(file) {
            if(!confirm("¿Eliminar archivo de la nube permanentemente?")) return;
            showToast("Eliminando...", "info");
            firestore.collection('uploads').doc(file.id).delete().then(() => {
                showToast("Eliminado de la nube", "success");
                window.loadCloudContent();
            }).catch((error) => {
                showToast("Error eliminando: " + error.code, "error");
            });
        }

        window.downloadCloudToLocal = function(file) {
            showToast("Descargando...", "info");
            fetch(file.data)
            .then(res => res.blob())
            .then(blob => {
                const newFile = { 
                    id: generateId(), 
                    parentId: 'root', 
                    name: file.name, 
                    size: file.size, 
                    type: file.type, 
                    createdAt: Date.now(), 
                    deletedAt: null, 
                    content: blob 
                };
                return DB.addFile(newFile);
            }).then(() => {
                showToast("Guardado en 'Mi Unidad' Local", "success");
            }).catch((error) => {
                showToast("Error descargando", "error");
                console.error(error);
            });
        }

        // TOAST SYSTEM
        window.showToast = function(msg, type='info') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
            el.className = `${colors[type] || 'bg-gray-800'} text-white px-4 py-3 rounded-lg shadow-lg text-sm font-medium toast flex items-center gap-2`;
            el.innerHTML = `<span>${msg}</span><button onclick="this.parentElement.remove()" class="ml-auto opacity-75 hover:opacity-100">✕</button>`;
            container.appendChild(el);
            requestAnimationFrame(() => el.classList.add('show'));
            setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 300); }, 5000);
        }

        window.toggleAutoUpload = function(val) {
            autoUpload = val;
            showToast(`Auto-subida ${val ? 'activada' : 'desactivada'}`, "info");
        }

        // --- DB & STATE ---
        const AppState = { currentFolderId: 'root', viewModeContext: 'local', viewMode: 'grid', files: [], folders: [], cloudFiles: [], trashMode: false, darkMode: false, db: null, sortBy: 'createdAt', sortOrder: 'desc' };
        const DB_NAME = 'LocalDriveDB', DB_VERSION = 1;

        class DB {
            static async open() {
                return new Promise((resolve, reject) => {
                    const r = indexedDB.open(DB_NAME, DB_VERSION);
                    r.onerror = e => reject(e);
                    r.onsuccess = e => { AppState.db = e.target.result; resolve(AppState.db); };
                    r.onupgradeneeded = e => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('files')) db.createObjectStore('files', { keyPath: 'id' }).createIndex('parentId', 'parentId');
                        if (!db.objectStoreNames.contains('folders')) db.createObjectStore('folders', { keyPath: 'id' }).createIndex('parentId', 'parentId');
                    };
                });
            }
            static async addFile(f) { return new Promise((res, rej) => { const t = AppState.db.transaction(['files'], 'readwrite'); t.objectStore('files').add(f).onsuccess = () => res(f); t.onerror = rej; }); }
            static async updateFile(f) { return new Promise((res, rej) => { const t = AppState.db.transaction(['files'], 'readwrite'); t.objectStore('files').put(f).onsuccess = () => res(f); t.onerror = rej; }); }
            static async addFolder(f) { return new Promise((res, rej) => { const t = AppState.db.transaction(['folders'], 'readwrite'); t.objectStore('folders').add(f).onsuccess = () => res(f); t.onerror = rej; }); }
            static async updateFolder(f) { return new Promise((res, rej) => { const t = AppState.db.transaction(['folders'], 'readwrite'); t.objectStore('folders').put(f).onsuccess = () => res(f); t.onerror = rej; }); }
            static async deleteItem(id, type, perm) {
                const store = type === 'folder' ? 'folders' : 'files';
                const t = AppState.db.transaction([store], 'readwrite');
                const s = t.objectStore(store);
                if (perm) s.delete(id);
                else s.get(id).onsuccess = e => { const i = e.target.result; if(i){ i.deletedAt = Date.now(); s.put(i); } };
                return new Promise(r => t.oncomplete = r);
            }
            static async restoreItem(id, type) {
                const store = type === 'folder' ? 'folders' : 'files';
                const t = AppState.db.transaction([store], 'readwrite');
                const s = t.objectStore(store);
                s.get(id).onsuccess = e => { const i = e.target.result; if(i){ i.deletedAt = null; s.put(i); } };
                return new Promise(r => t.oncomplete = r);
            }
            static async getAll() {
                const t = AppState.db.transaction(['files', 'folders'], 'readonly');
                const fR = t.objectStore('files').getAll();
                const dR = t.objectStore('folders').getAll();
                return Promise.all([new Promise(r => fR.onsuccess = () => r(fR.result)), new Promise(r => dR.onsuccess = () => r(dR.result))]);
            }
        }

        const generateId = () => Math.random().toString(36).substr(2, 9);
        const formatSize = b => { if(b===0)return '0 B'; const k=1024, i=Math.floor(Math.log(b)/Math.log(k)); return parseFloat((b/Math.pow(k,i)).toFixed(2))+' '+['B','KB','MB','GB'][i]; };

        // Attach global functions to window
        window.initApp = async function() {
            await DB.open();
            if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark'); AppState.darkMode = true;
            }
            const savedSort = localStorage.getItem('sortBy');
            const savedOrder = localStorage.getItem('sortOrder');
            if(savedSort && ['name', 'createdAt', 'size', 'extension'].includes(savedSort)) AppState.sortBy = savedSort;
            if(savedOrder) AppState.sortOrder = savedOrder;
            
            await loadContent();
            setupDragDrop();
        };

        async function loadContent() {
            const [files, folders] = await DB.getAll();
            AppState.files = files; AppState.folders = folders;
            render();
            updateStorageStats();
        }

        function render() {
            const container = document.getElementById('file-container');
            const emptyState = document.getElementById('empty-state');
            const dashboard = document.getElementById('dashboard-view');
            
            // HIGHLIGHT ACTIVE NAV
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('bg-blue-50', 'text-blue-700', 'dark:bg-gray-800', 'dark:text-blue-300'));
            if(AppState.currentFolderId === 'dashboard') document.getElementById('nav-stats').classList.add('bg-blue-50', 'text-blue-700', 'dark:bg-gray-800', 'dark:text-blue-300');
            else if(AppState.currentFolderId === 'trash') document.getElementById('nav-trash').classList.add('bg-blue-50', 'text-blue-700', 'dark:bg-gray-800', 'dark:text-blue-300');
            else if(AppState.viewModeContext === 'cloud') document.getElementById('nav-cloud').classList.add('bg-blue-50', 'text-blue-700', 'dark:bg-gray-800', 'dark:text-blue-300');
            else document.getElementById('nav-root').classList.add('bg-blue-50', 'text-blue-700', 'dark:bg-gray-800', 'dark:text-blue-300');

            if (AppState.currentFolderId === 'dashboard') {
                container.classList.add('hidden'); emptyState.classList.add('hidden'); dashboard.classList.remove('hidden');
                document.getElementById('cloud-loading').classList.add('hidden');
                renderDashboard(); updateBreadcrumbs([{id: 'dashboard', name: 'Estadísticas'}]); return;
            } else {
                dashboard.classList.add('hidden'); container.classList.remove('hidden');
            }

            // CLOUD MODE RENDER
            if (AppState.viewModeContext === 'cloud') {
                updateBreadcrumbs([{id: 'cloud', name: 'Nube Firebase'}]);
                document.getElementById('add-folder-btn').classList.add('hidden');
                return;
            }

            // LOCAL MODE RENDER
            document.getElementById('add-folder-btn').classList.remove('hidden');
            document.getElementById('cloud-loading').classList.add('hidden');
            container.innerHTML = '';

            const isTrash = AppState.currentFolderId === 'trash';
            AppState.trashMode = isTrash;
            const term = document.getElementById('searchInput').value.toLowerCase();
            
            let folders = AppState.folders.filter(f => isTrash ? f.deletedAt : (!f.deletedAt && f.parentId === AppState.currentFolderId));
            let files = AppState.files.filter(f => isTrash ? f.deletedAt : (!f.deletedAt && f.parentId === AppState.currentFolderId));

            if (term && !isTrash) {
                folders = AppState.folders.filter(f => !f.deletedAt && f.name.toLowerCase().includes(term));
                files = AppState.files.filter(f => !f.deletedAt && f.name.toLowerCase().includes(term));
            }

            const sortFn = (a, b) => {
                let valA, valB;
                if (AppState.sortBy === 'extension') {
                    valA = (a.name || "").split('.').pop(); valB = (b.name || "").split('.').pop();
                } else if (AppState.sortBy === 'name') {
                    valA = a.name || ""; valB = b.name || "";
                } else {
                    valA = a[AppState.sortBy] || 0; valB = b[AppState.sortBy] || 0;
                }
                let comparison = 0;
                if (typeof valA === 'string' && typeof valB === 'string') comparison = valA.localeCompare(valB, 'es', { sensitivity: 'base' });
                else { if (valA < valB) comparison = -1; if (valA > valB) comparison = 1; }
                return comparison * (AppState.sortOrder === 'asc' ? 1 : -1);
            };

            folders.sort(sortFn); files.sort(sortFn);

            if (files.length === 0 && folders.length === 0) {
                document.getElementById('empty-state').innerHTML = `
                    <svg class="w-32 h-32 mb-4 opacity-50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                    <p class="text-lg font-medium">Esta carpeta está vacía</p>
                    <p class="text-sm">Arrastra archivos aquí o usa el botón Nuevo</p>
                `;
                emptyState.classList.remove('hidden');
            }
            else emptyState.classList.add('hidden');

            if (!term) updateBreadcrumbs(isTrash ? [{id: 'trash', name: 'Papelera'}] : getBreadcrumbs(AppState.currentFolderId));

            folders.forEach(f => container.appendChild(createItemElement(f, 'folder')));
            files.forEach(f => container.appendChild(createItemElement(f, 'file')));
            
            container.className = AppState.viewMode === 'grid' ? 'folder-grid pb-20 p-2' : 'list-view pb-20 p-2';
            updateSortMenuUI();
        }

        function createItemElement(item, type) {
            const div = document.createElement('div');
            const isGrid = AppState.viewMode === 'grid';
            div.className = isGrid ? `group relative bg-white dark:bg-gray-800 p-4 rounded-xl border dark:border-gray-700 hover:shadow-lg transition-all cursor-pointer flex flex-col items-center gap-3 select-none` : `group relative bg-white dark:bg-gray-800 p-3 rounded-lg border dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all cursor-pointer flex items-center gap-4 select-none`;
            div.draggable = true;
            div.dataset.id = item.id;
            
            const icon = type === 'folder' 
                ? `<svg class="w-12 h-12 text-yellow-500 fill-current" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>`
                : getFileIcon(item.name);

            const menuBtn = `<button onclick="window.openMenuFor(event, '${item.id}', '${type}')" class="absolute top-2 right-2 p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 opacity-0 group-hover:opacity-100 transition-opacity z-10"><svg class="w-5 h-5 text-gray-500" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg></button>`;

            if (isGrid) {
                div.innerHTML = `${menuBtn}<div class="w-full flex justify-center pointer-events-none">${icon}</div><div class="text-center w-full overflow-hidden"><p class="text-sm font-medium text-gray-700 dark:text-gray-200 truncate w-full" title="${item.name}">${item.name}</p><p class="text-xs text-gray-400 mt-1">${type === 'file' ? formatSize(item.size) : '-'}</p></div>`;
            } else {
                div.innerHTML = `<div class="flex-shrink-0">${icon.replace('w-12 h-12', 'w-8 h-8')}</div><div class="flex-1 min-w-0"><p class="text-sm font-medium text-gray-700 dark:text-gray-200 truncate">${item.name}</p></div><div class="text-xs text-gray-400 w-24 text-right mr-8">${type === 'file' ? formatSize(item.size) : '-'}</div>${menuBtn.replace('top-2 right-2', 'top-1/2 -translate-y-1/2 right-2')}`;
            }

            div.ondblclick = () => type === 'folder' ? window.navigate(item.id) : window.previewFile(item);
            div.oncontextmenu = e => window.showContextMenu(e, item, type);
            div.ondragstart = e => { e.dataTransfer.setData('application/json', JSON.stringify({id: item.id, type})); div.style.opacity = '0.5'; };
            div.ondragend = () => div.style.opacity = '1';
            if (type === 'folder') {
                div.ondragover = e => { e.preventDefault(); div.classList.add('ring-2', 'ring-blue-500'); };
                div.ondragleave = () => div.classList.remove('ring-2', 'ring-blue-500');
                div.ondrop = e => window.handleDropOnFolder(e, item.id);
            }
            return div;
        }

        window.navigate = function(id) { 
            document.getElementById('searchInput').value = '';
            
            if (id === 'cloud') {
                AppState.viewModeContext = 'cloud';
                AppState.currentFolderId = 'cloud';
                render();
                window.loadCloudContent();
            } else {
                AppState.viewModeContext = 'local';
                AppState.currentFolderId = id; 
                render(); 
            }
        }

        function getBreadcrumbs(id) {
            if (id === 'root') return [{id: 'root', name: 'Mi Unidad'}];
            let path = [], curr = AppState.folders.find(f => f.id === id);
            while(curr) { path.unshift({id: curr.id, name: curr.name}); curr = AppState.folders.find(f => f.id === curr.parentId); }
            if(path.length && path[0].id !== 'root') path.unshift({id:'root', name:'Mi Unidad'});
            return path;
        }
        function updateBreadcrumbs(path) {
            document.getElementById('breadcrumbs').innerHTML = path.map((c, i) => 
                `<span class="flex items-center cursor-pointer hover:text-blue-500 ${i===path.length-1?'font-bold text-gray-800 dark:text-white':''}" onclick="window.navigate('${c.id}')">${c.name}</span>` + (i<path.length-1?'<span class="text-gray-400 mx-1">/</span>':'')
            ).join('');
        }

        // Sort
        window.toggleSortMenu = function(e) { e.stopPropagation(); document.getElementById('sort-menu').classList.toggle('hidden'); }
        window.setSort = function(criteria) {
            if (AppState.sortBy === criteria) window.toggleSortOrder();
            else { AppState.sortBy = criteria; localStorage.setItem('sortBy', criteria); render(); document.getElementById('sort-menu').classList.add('hidden'); }
        }
        window.toggleSortOrder = function() {
            AppState.sortOrder = AppState.sortOrder === 'asc' ? 'desc' : 'asc'; localStorage.setItem('sortOrder', AppState.sortOrder); render(); document.getElementById('sort-menu').classList.add('hidden');
        }
        function updateSortMenuUI() {
            ['name', 'createdAt', 'size', 'extension'].forEach(c => { const el=document.getElementById('check-'+c); if(el)el.classList.add('opacity-0'); });
            const activeEl = document.getElementById('check-' + AppState.sortBy); if(activeEl) activeEl.classList.remove('opacity-0');
            document.getElementById('sort-order-icon').innerText = AppState.sortOrder === 'asc' ? '⬆️' : '⬇️';
            document.getElementById('sort-order-text').innerText = AppState.sortOrder === 'asc' ? 'Ascendente' : 'Descendente';
        }

        // Modals
        let pendingAction = null; 
        window.openInputModal = function(mode, item = null, itemType = null) {
            document.getElementById('new-menu').classList.add('hidden'); pendingAction = { mode, item, itemType };
            const titleEl = document.getElementById('input-modal-title'), inputEl = document.getElementById('input-modal-value');
            if (mode === 'create') { titleEl.textContent = "Nueva Carpeta"; inputEl.value = "Nueva Carpeta"; } 
            else if (mode === 'rename') { titleEl.textContent = "Renombrar"; inputEl.value = item.name; }
            document.getElementById('input-modal').classList.remove('hidden'); inputEl.focus(); inputEl.select();
        }
        window.submitInputModal = async function() {
            const val = document.getElementById('input-modal-value').value; if (!val) return;
            document.getElementById('input-modal').classList.add('hidden');
            if (pendingAction.mode === 'create') {
                const f = { id: generateId(), parentId: ['trash','dashboard'].includes(AppState.currentFolderId) ? 'root' : AppState.currentFolderId, name: val, createdAt: Date.now(), deletedAt: null }; await DB.addFolder(f);
            } else if (pendingAction.mode === 'rename') {
                pendingAction.item.name = val; pendingAction.itemType === 'file' ? await DB.updateFile(pendingAction.item) : await DB.updateFolder(pendingAction.item);
            }
            loadContent(); pendingAction = null;
        }

        let pendingDelete = null;
        function confirmDelete(item, type) { pendingDelete = { item, type }; document.getElementById('confirm-modal').classList.remove('hidden'); }
        window.submitConfirmModal = async function() {
            if(pendingDelete) { await DB.deleteItem(pendingDelete.item.id, pendingDelete.type, true); loadContent(); }
            document.getElementById('confirm-modal').classList.add('hidden'); pendingDelete = null;
        }

        // Conflict
        let conflictResolver = null;
        function checkConflict(name, parentId) { return AppState.files.find(f => f.parentId === parentId && f.name === name && !f.deletedAt); }
        window.resolveConflict = function(choice) { if (conflictResolver) conflictResolver(choice); document.getElementById('conflict-modal').classList.add('hidden'); }
        function showConflictModal(filename) {
            document.getElementById('conflict-filename').textContent = filename; document.getElementById('conflict-modal').classList.remove('hidden');
            return new Promise(resolve => { conflictResolver = resolve; });
        }

        // UI Helpers
        window.toggleNewMenu = function(e) { e.stopPropagation(); document.getElementById('new-menu').classList.toggle('hidden'); }
        window.handleClickOutside = function(e) { 
            const newMenu = document.getElementById('new-menu'), newBtn = document.getElementById('new-btn');
            const sortMenu = document.getElementById('sort-menu'), sortBtn = document.getElementById('sort-btn');
            if(!newMenu.contains(e.target) && !newBtn.contains(e.target)) newMenu.classList.add('hidden');
            if(sortMenu && !sortMenu.contains(e.target) && !sortBtn.contains(e.target)) sortMenu.classList.add('hidden');
        }
        window.triggerUpload = function(type) { document.getElementById('new-menu').classList.add('hidden'); document.getElementById(type+'Input').click(); }
        
        window.handleFileSelect = async function(e, targetParentId = null) {
            const files = Array.from(e.target.files); if (!files.length) return;
            const parentId = targetParentId || (['trash','dashboard','cloud'].includes(AppState.currentFolderId) ? 'root' : AppState.currentFolderId);
            const folderCache = {};
            const ensureFolder = async (parts, root) => {
                let curr = root, path = "";
                for (const p of parts) {
                    path += (path?"/":"")+p; if(folderCache[path]) { curr = folderCache[path]; continue; }
                    const exist = AppState.folders.find(f => f.parentId === curr && f.name === p && !f.deletedAt);
                    if(exist) curr = exist.id;
                    else { const newF = { id: generateId(), parentId: curr, name: p, createdAt: Date.now(), deletedAt: null }; await DB.addFolder(newF); AppState.folders.push(newF); curr = newF.id; }
                    folderCache[path] = curr;
                } return curr;
            };

            for (const f of files) {
                let pid = parentId;
                if(f.webkitRelativePath) { const parts = f.webkitRelativePath.split('/'); parts.pop(); if(parts.length) pid = await ensureFolder(parts, parentId); }
                const existing = checkConflict(f.name, pid); let finalName = f.name;
                if (existing) {
                    const choice = await showConflictModal(f.name);
                    if (choice === 'cancel') continue;
                    if (choice === 'replace') { existing.content = f; existing.size = f.size; existing.updatedAt = Date.now(); await DB.updateFile(existing); if(autoUpload) uploadFileToFirebase(existing); continue; }
                    if (choice === 'rename') { const newName = prompt("Nuevo nombre:", f.name); if (!newName) continue; finalName = newName; }
                }
                const newFile = { id: generateId(), parentId: pid, name: finalName, size: f.size, type: f.type, createdAt: Date.now(), deletedAt: null, content: f };
                await DB.addFile(newFile);
                if(autoUpload) { uploadFileToFirebase(newFile); }
            }
            e.target.value = ''; loadContent();
        }

        // Drag Drop
        function setupDragDrop() {
            const z = document.getElementById('drop-zone');
            window.ondragover = e => { e.preventDefault(); z.classList.add('active'); };
            z.ondragleave = () => z.classList.remove('active');
            z.ondrop = e => { e.preventDefault(); z.classList.remove('active'); if(e.dataTransfer.files.length) window.handleFileSelect({target: {files: e.dataTransfer.files}}); };
        }
        window.handleDropOnFolder = async function(e, targetId) {
            e.stopPropagation(); const data = e.dataTransfer.getData('application/json');
            if (!data && e.dataTransfer.files.length > 0) { window.handleFileSelect({target: {files: e.dataTransfer.files}}, targetId); return; }
            if (data) {
                const item = JSON.parse(data); if (item.id === targetId) return;
                if (item.type === 'file') { const f = AppState.files.find(x => x.id === item.id); if(f) { f.parentId = targetId; await DB.updateFile(f); } }
                else { const f = AppState.folders.find(x => x.id === item.id); if(f && f.id !== targetId) { f.parentId = targetId; await DB.updateFolder(f); } }
                loadContent();
            }
        }

        // Context Menu
        let ctxTarget = null;
        window.openMenuFor = function(e, id, type) { e.stopPropagation(); 
            if(type === 'cloudFile') {
                const item = AppState.cloudFiles.find(x => x.id === id);
                window.showContextMenu(e, item, type);
            } else {
                const item = type === 'file' ? AppState.files.find(x => x.id === id) : AppState.folders.find(x => x.id === id); 
                window.showContextMenu(e, item, type);
            }
        }
        window.showContextMenu = function(e, item, type) {
            e.preventDefault(); ctxTarget = { item, type };
            const m = document.getElementById('context-menu');
            if (type === 'cloudFile') {
                document.getElementById('ctx-default-actions').classList.add('hidden');
                document.getElementById('ctx-cloud-actions').classList.remove('hidden');
                document.getElementById('ctx-restore').classList.add('hidden');
                document.getElementById('ctx-perm-delete').classList.add('hidden');
            } else {
                document.getElementById('ctx-default-actions').classList.remove('hidden');
                document.getElementById('ctx-cloud-actions').classList.add('hidden');
                document.getElementById('ctx-restore').classList.toggle('hidden', !AppState.trashMode);
                document.getElementById('ctx-perm-delete').classList.toggle('hidden', !AppState.trashMode);
            }
            const rect = e.target.getBoundingClientRect ? e.target.getBoundingClientRect() : {left: e.clientX, top: e.clientY};
            const x = e.clientX || rect.left; const y = e.clientY || rect.bottom;
            m.style.left = Math.min(x, window.innerWidth - 200) + 'px'; m.style.top = Math.min(y, window.innerHeight - 200) + 'px'; m.classList.remove('hidden');
            const close = () => { m.classList.add('hidden'); document.removeEventListener('click', close); };
            setTimeout(() => document.addEventListener('click', close), 10);
        }
        window.ctxAction = async function(act) {
            if (!ctxTarget) return;
            const { item, type } = ctxTarget;
            if (act === 'downloadToLocal') window.downloadCloudToLocal(item);
            if (act === 'deleteCloud') window.deleteCloudFile(item);
            if (act === 'open') type === 'cloudFile' ? window.previewCloudFile(item) : (type === 'folder' ? window.navigate(item.id) : window.previewFile(item));
            if (act === 'rename') window.openInputModal('rename', item, type);
            if (act === 'delete') { await DB.deleteItem(item.id, type, false); loadContent(); }
            if (act === 'restore') { await DB.restoreItem(item.id, type); loadContent(); }
            if (act === 'permDelete') confirmDelete(item, type);
            if (act === 'move') window.showMoveModal(item, type);
            if (act === 'uploadCloud') uploadFileToFirebase(item);
        }

        window.showMoveModal = function(item, type) {
            const modal = document.getElementById('move-modal'), list = document.getElementById('move-list'); list.innerHTML = ''; modal.classList.remove('hidden');
            const renderTree = (parentId, depth) => {
                const subs = AppState.folders.filter(f => f.parentId === parentId && !f.deletedAt && f.id !== item.id);
                subs.forEach(f => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2 text-sm dark:text-gray-200";
                    btn.style.paddingLeft = (depth * 20 + 10) + 'px';
                    btn.innerHTML = `<svg class="w-4 h-4 text-yellow-500 fill-current" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg> ${f.name}`;
                    btn.onclick = async () => { item.parentId = f.id; type === 'file' ? await DB.updateFile(item) : await DB.updateFolder(item); modal.classList.add('hidden'); loadContent(); };
                    list.appendChild(btn); renderTree(f.id, depth + 1);
                });
            };
            const rootBtn = document.createElement('button'); rootBtn.className = "w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2 text-sm font-bold dark:text-white border-b dark:border-gray-700"; rootBtn.innerHTML = "Mi Unidad (Raíz)";
            rootBtn.onclick = async () => { item.parentId = 'root'; type === 'file' ? await DB.updateFile(item) : await DB.updateFolder(item); modal.classList.add('hidden'); loadContent(); };
            list.appendChild(rootBtn); renderTree('root', 0);
        }

        // Preview & Audio
        let currUrl = null, currAudio = null;
        window.closePreview = function() {
            document.getElementById('preview-modal').classList.add('hidden');
            if(currUrl) URL.revokeObjectURL(currUrl);
            if(currAudio) { currAudio.pause(); currAudio = null; }
            document.getElementById('audio-controls').classList.add('hidden');
        }
        window.previewFile = function(f) {
            window.closePreview();
            document.getElementById('preview-modal').classList.remove('hidden'); document.getElementById('preview-title').textContent = f.name;
            const c = document.getElementById('preview-content'); currUrl = URL.createObjectURL(f.content);
            if (f.type.startsWith('image/')) c.innerHTML = `<img src="${currUrl}" class="max-w-full max-h-full object-contain">`;
            else if (f.type.startsWith('video/')) c.innerHTML = `<video controls autoplay class="max-w-full max-h-full"><source src="${currUrl}" type="${f.type}"></video>`;
            else if (f.type.startsWith('audio/')) { c.innerHTML = `<div class="text-center text-white"><div class="w-32 h-32 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse"><svg class="w-16 h-16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></div><h2 class="text-2xl font-light">${f.name}</h2></div>`; setupAudio(currUrl); }
            else if (f.type === 'application/pdf') c.innerHTML = `<iframe src="${currUrl}" class="w-full h-full border-none"></iframe>`;
            else if (f.name.match(/\.(txt|md|js|json|html|css|py)$/)) {
                const r = new FileReader(); r.onload = e => c.innerHTML = `<pre class="bg-[#282c34] text-[#abb2bf] p-6 rounded-lg w-full h-full overflow-auto font-mono text-sm"><code>${e.target.result.replace(/[<>]/g,m=>({'<':'&lt;','>':'&gt;'}[m])).replace(/\b(function|const|let|var)\b/g,'<span class="code-keyword">$1</span>')}</code></pre>`; r.readAsText(f.content);
            } else c.innerHTML = `<div class="text-center text-white"><p>Vista previa no disponible</p><button onclick="window.downloadCurrentPreview()" class="mt-4 bg-blue-600 px-4 py-2 rounded">Descargar</button></div>`;
        }
        window.downloadCurrentPreview = function() { const a = document.createElement('a'); a.href = currUrl; a.download = document.getElementById('preview-title').textContent; a.click(); }
        function setupAudio(url) {
            const ctrl = document.getElementById('audio-controls'); ctrl.classList.remove('hidden'); currAudio = new Audio(url);
            const btn = document.getElementById('audio-play-btn'), range = document.getElementById('audio-slider');
            btn.onclick = () => { if(currAudio.paused){ currAudio.play(); btn.innerHTML='II'; } else { currAudio.pause(); btn.innerHTML='▶'; } };
            currAudio.ontimeupdate = () => { range.value = (currAudio.currentTime/currAudio.duration)*100; document.getElementById('audio-current').innerText = fmtTime(currAudio.currentTime); };
            currAudio.onloadedmetadata = () => document.getElementById('audio-total').innerText = fmtTime(currAudio.duration);
            range.oninput = e => currAudio.currentTime = (e.target.value/100)*currAudio.duration;
        }
        const fmtTime = s => `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`;

        function getFileIcon(n) {
            const x = n.split('.').pop().toLowerCase();
            let c = 'text-gray-500', p = '<path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>';
            if(['jpg','png','svg'].includes(x)) { c='text-purple-500'; p='<rect x="3" y="3" width="18" height="18" rx="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline>'; }
            if(['pdf'].includes(x)) { c='text-red-500'; p='<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line>'; }
            return `<svg class="w-12 h-12 ${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">${p}</svg>`;
        }
        window.toggleTheme = function() { AppState.darkMode = !AppState.darkMode; document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', AppState.darkMode?'dark':'light'); }
        window.toggleLayout = function() { AppState.viewMode = AppState.viewMode==='grid'?'list':'grid'; render(); }
        window.showDashboard = function() { window.navigate('dashboard'); }
        window.handleSearch = function() { render(); }
        function renderDashboard() {
            const files = AppState.files;
            document.getElementById('stat-count').innerText = files.length;
            document.getElementById('stat-size').innerText = formatSize(files.reduce((a,c)=>a+c.size,0));
            document.getElementById('stat-trash').innerText = files.filter(f=>f.deletedAt).length;
            const ctx = document.getElementById('fileTypeChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            const types = {}; files.forEach(f=>{ const x=f.name.split('.').pop().toUpperCase(); types[x]=(types[x]||0)+1; });
            if(typeof Chart!=='undefined') window.myChart = new Chart(ctx, {type:'bar', data:{labels:Object.keys(types), datasets:[{label:'Tipos', data:Object.values(types), backgroundColor:'#3b82f6'}]}});
        }
        function updateStorageStats() {
            const s = AppState.files.reduce((a,c)=>a+c.size,0);
            document.getElementById('storage-bar').style.width = Math.min((s/1073741824)*100,100)+'%';
            document.getElementById('storage-text').innerText = formatSize(s)+' usados';
        }
        window.exportData = function() {
            const b = new Blob([JSON.stringify({files:AppState.files.map(f=>({...f,content:null})),folders:AppState.folders},null,2)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'backup.json'; a.click();
        }

        window.initApp();
    </script>
</body>
</html>
